<!DOCTYPE html>
<!--
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•   â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
   â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•        â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•   
  
  Â© 2025 INFINITY Nova Urban Intelligence. Todos los derechos reservados.
  
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  AVISO LEGAL Y COPYRIGHT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  Este documento, incluyendo pero no limitado a:
  - CÃ³digo fuente HTML, CSS y JavaScript
  - AnÃ¡lisis de mercado y datos urbanÃ­sticos
  - GrÃ¡ficos, mapas y visualizaciones
  - Textos, informes y conclusiones
  - Estructura, diseÃ±o y metodologÃ­a
  
  Es PROPIEDAD EXCLUSIVA y CONFIDENCIAL de INFINITY Nova y estÃ¡ protegido
  por las leyes de Propiedad Intelectual de EspaÃ±a, la UniÃ³n Europea y
  tratados internacionales.
  
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  RESTRICCIONES DE USO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  â›” PROHIBIDO:
  â€¢ Copiar, reproducir o duplicar este contenido
  â€¢ Modificar, adaptar o crear obras derivadas
  â€¢ Distribuir, publicar o transmitir por cualquier medio
  â€¢ Extraer datos mediante scraping, crawling o tÃ©cnicas automatizadas
  â€¢ Uso comercial o con fines lucrativos
  â€¢ IngenierÃ­a inversa del cÃ³digo o metodologÃ­a
  â€¢ Captura de pantalla sin autorizaciÃ³n
  â€¢ Cualquier forma de almacenamiento no autorizado
  
  âœ… PERMITIDO:
  â€¢ VisualizaciÃ³n personal en navegador
  â€¢ Enlaces directos a la URL oficial
  
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PROTECCIONES TÃ‰CNICAS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  Este documento incluye:
  â€¢ Watermarks digitales invisibles
  â€¢ Sistema de detecciÃ³n de copia
  â€¢ Tracking de accesos no autorizados
  â€¢ ProtecciÃ³n contra herramientas de desarrollo
  â€¢ Fingerprinting de sesiÃ³n
  
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CONSECUENCIAS LEGALES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  El uso no autorizado de este contenido constituye:
  1. InfracciÃ³n de derechos de autor (Arts. 270-272 CÃ³digo Penal)
  2. Competencia desleal (Ley 3/1991)
  3. ViolaciÃ³n de secretos empresariales (Ley 1/2019)
  
  Las infracciones pueden resultar en:
  â€¢ Acciones civiles por daÃ±os y perjuicios
  â€¢ Denuncia penal (penas de hasta 4 aÃ±os de prisiÃ³n)
  â€¢ Multas de hasta 240.000â‚¬
  â€¢ Orden de cese y retirada del contenido
  â€¢ PublicaciÃ³n de sentencia condenatoria
  
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CONTACTO Y PERMISOS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  Para solicitar autorizaciÃ³n de uso:
  ğŸ“§ legal@infinitynova.xyz
  ğŸŒ https://infinitynova.xyz/legal/licensing
  
  Document ID: ALY-OLV56-2025-001
  Watermark: WM-7F8A9B2C-E4D6-11EF-9A8B-0242AC120002
  Generated: 2025-10-21T23:20:00Z
  
-->
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="copyright" content="Â© 2025 INFINITY Nova Urban Intelligence. All rights reserved." />
<meta name="author" content="INFINITY Nova" />
<meta name="robots" content="noarchive, nocache" />
<meta property="og:type" content="website" />
<meta property="og:title" content="AnÃ¡lisis de Mercado Inmobiliario - Alcoy" />
<meta property="og:description" content="AnÃ¡lisis urbanÃ­stico propietario - Contenido protegido" />
<title>Urban & Delta Legal Division - Â© INFINITY Nova 2025</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">

<script>
  (function() {
    'use strict';
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
          (e.ctrlKey && (e.key === 'u' || e.key === 's'))) {
        e.preventDefault();
        return false;
      }
    });
  })();
</script>
<style>
  :root{
    --bg:#0e0f13;
    --panel:#151821;
    --muted:#8a93a6;
    --text:#e9ecf1;
    --accent:#7dd3fc;
    --accent2:#a78bfa;
    --good:#34d399;
    --warn:#fbbf24;
    --risk:#f87171;
    --chip:#1f2431;
    --grid: rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    background: radial-gradient(1200px 800px at 10% -10%, rgba(124,58,237,.2), transparent 60%),
                radial-gradient(800px 600px at 100% 30%, rgba(14,165,233,.18), transparent 50%), var(--bg);
    color:var(--text);
    display:flex; flex-direction:column;
  }
  header{
    padding:18px 22px; border-bottom:1px solid var(--grid); backdrop-filter: blur(6px);
    position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(8,9,12,.7), rgba(8,9,12,.35));
    display:flex; justify-content:space-between; align-items:center;
  }
  .header-content-left {
    display:flex; align-items:center;
    flex:1;
  }
  header h1{margin:0; font-size:20px; letter-spacing:.2px}
  header small{color:var(--muted)}
  .header-logo{display:flex; align-items:center; margin-right:15px}
  .logo-image{height:40px; width:auto; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
  .header-left{display:flex; flex-direction:column; gap:2px}
  .header-right{display:flex; flex-direction:column; align-items:flex-end; gap:2px}
  .domain{color:var(--accent); font-size:14px; font-weight:500; text-decoration:none}
  .domain:hover{color:var(--accent2)}
  
  /* ProtecciÃ³n contra herramientas de desarrollador */
  body{
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{display:grid; grid-template-columns: 320px 1fr; gap:18px; padding:18px; flex:1; min-height:0; height:calc(100vh - 120px)}
  aside{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)), var(--panel);
    border:1px solid var(--grid); border-radius:14px; padding:14px; 
    overflow:visible; display:flex; flex-direction:column; gap:6px;
  }
  aside h4{margin:10px 0 6px 0; font-size:13px; font-weight:600; color:var(--text);}
  main{display:flex; flex-direction:column; gap:14px; min-height:0; height:100%}
  .toolbar{
    background:var(--panel); border:1px solid var(--grid); border-radius:14px; padding:12px; display:grid; gap:10px;
    grid-template-columns: 1fr 220px 220px;
  }
  .toolbar input[type="search"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--grid); background:#0d1018; color:var(--text);
    outline:none;
  }
  .toolbar select{
    width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--grid); background:#0d1018; color:var(--text);
    outline:none;
  }
  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
  .chip{
    padding:7px 10px; border-radius:999px; background:var(--chip); color:var(--text); border:1px solid var(--grid);
    cursor:pointer; user-select:none; font-size:12px;
  }
  .chip[data-active="true"]{outline:2px solid var(--accent); background:#0b1220}
  .viewtabs{display:flex; gap:8px; margin-top:8px}
  .tab{flex:1; text-align:center; padding:8px; border-radius:10px; background:var(--chip); border:1px solid var(--grid); cursor:pointer}
  .tab[data-active="true"]{outline:2px solid var(--accent2); background:#120f1a}
  .grid{
    display:grid; grid-template-columns: repeat(12, 1fr);
    gap:12px; align-content:start; min-height:0; overflow:auto; padding:2px;
  }
  .card{
    grid-column: span 4;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--panel);
    border:1px solid var(--grid); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px; position:relative;
  }
  .card h3{margin:0; font-size:16px}
  .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px}
  .badge{padding:4px 8px; background:#0d1018; border:1px solid var(--grid); border-radius:999px}
  .thumb{
    width:100%; aspect-ratio: 16/10; object-fit:cover; border-radius:10px; border:1px solid var(--grid); background:#0d1018;
  }
  .actions{display:flex; gap:8px; margin-top:auto}
  button, a.button{
    padding:8px 10px; border-radius:10px; border:1px solid var(--grid); background:#0d1018; color:var(--text); cursor:pointer; text-decoration:none;
  }
  button.primary, a.button.primary{background:linear-gradient(90deg, rgba(124,58,237,.35), rgba(14,165,233,.35)); border-color:#2b3243}
  .hidden{display:none !important}
  /* Map view */
  .mapwrap{
    position:relative; flex:1; background:linear-gradient(transparent, rgba(255,255,255,.01)), var(--panel);
    border:1px solid var(--grid); border-radius:14px; overflow:hidden; min-height:500px;
  }
  #map { 
    height: 100%; 
    min-height: 500px;
    width: 100%;
  }
  /* Fullscreen map mode */
  .mapwrap.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    border: none;
    border-radius: 0;
  }
  .mapwrap.fullscreen #map {
    height: 100vh;
  }
  /* Sidebar para filtros en pantalla completa */
  .map-sidebar {
    position: absolute;
    left: -280px;
    top: 0;
    width: 280px;
    height: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)), var(--panel);
    border-right: 1px solid var(--grid);
    padding: 16px;
    overflow-y: auto;
    z-index: 600;
    transition: left 0.3s ease;
  }
  .map-sidebar.open {
    left: 0;
  }
  .map-sidebar h4 {
    margin: 14px 0 6px;
    color: var(--text);
    font-size: 14px;
  }
  .map-sidebar input[type="search"] {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--grid);
    background: #0d1018;
    color: var(--text);
    outline: none;
    font-size: 12px;
  }
  .map-sidebar select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--grid);
    background: #0d1018;
    color: var(--text);
    outline: none;
    font-size: 12px;
  }
  /* Estilos del botÃ³n sidebar-toggle eliminados */
  .map-controls {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 500;
    display: flex;
    gap: 8px;
    flex-direction: column;
  }
  .map-controls button, .map-controls select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--grid);
    background: var(--panel);
    color: var(--text);
    cursor: pointer;
    font-size: 12px;
  }
  .map-controls button.active {
    background: linear-gradient(90deg, rgba(124,58,237,.35), rgba(14,165,233,.35));
    border-color: var(--accent);
  }
  .rotation-controls {
    display: none;
    gap: 4px;
  }
  .rotation-controls.visible {
    display: flex;
  }
  .rotation-controls button {
    padding: 6px 10px;
    font-size: 11px;
  }
  /* Panel de Control 3D */
  .control-panel-3d {
    position: absolute;
    top: 20px;
    left: 20px;
    background: var(--panel);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--grid);
    z-index: 600;
    max-width: 280px;
    display: none;
  }
  .control-panel-3d.visible {
    display: block;
  }
  .control-panel-3d h3 {
    font-size: 16px;
    margin: 0 0 12px 0;
    color: var(--text);
    font-weight: 600;
  }
  .control-group {
    margin-bottom: 12px;
  }
  .control-group label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
    font-weight: 500;
  }
  .slider-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  input[type="range"] {
    flex: 1;
    appearance: none;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--chip);
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: background 0.2s;
  }
  input[type="range"]::-webkit-slider-thumb:hover {
    background: var(--accent2);
  }
  input[type="range"]::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: none;
  }
  .value-display {
    min-width: 35px;
    text-align: right;
    font-size: 11px;
    color: var(--text);
    font-weight: 500;
  }
  /* Estilos para popups de MapLibre */
  .maplibregl-popup-content {
    background: #0e1422 !important;
    border: 1px solid var(--border) !important;
    color: var(--text) !important;
    border-radius: 14px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,.35) !important;
    padding: 0 !important;
  }
  .maplibregl-popup-tip {
    border-top-color: #0e1422 !important;
  }
  .popup-content {
    max-width: 360px;
    padding: 14px;
  }
  .popup-content h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  .popup-content .addr {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 10px;
  }
  .popup-content .popup-chips {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin: 6px 0;
  }
  .popup-content .popup-chip {
    background: #121a2b;
    border: 1px solid var(--border);
    font-size: 12px;
    padding: 5px 10px;
    border-radius: 999px;
    color: #d1d5db;
  }
  .popup-content .coords-box {
    font-family: ui-monospace, 'Courier New', monospace;
    background: #0b0f19;
    border: 1px dashed var(--border);
    border-radius: 8px;
    padding: 6px 8px;
    color: #9fb0c8;
    font-size: 13px;
    display: flex;
    gap: 6px;
    align-items: center;
    margin: 8px 0;
  }
  .popup-content .metrics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    margin-top: 8px;
  }
  .popup-content .metric-box {
    background: #0b0f19;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
  }
  .popup-content .metric-box b {
    display: block;
    font-size: 14px;
    color: var(--text);
    margin-bottom: 3px;
  }
  .popup-content .metric-box small {
    color: var(--muted);
    font-size: 12px;
  }
  .popup-content .note-box {
    margin-top: 8px;
    padding: 10px;
    background: #fef3c7;
    border-radius: 8px;
    font-size: 13px;
    color: #92400e;
    border: 1px solid #fbbf24;
    line-height: 1.4;
  }
  .popup-content .note-box strong {
    color: #78350f;
  }
  .popup-content p {
    margin: 8px 0;
    font-size: 14px;
    color: #d1d5db;
    line-height: 1.5;
  }
  /* Leyenda de categorÃ­as */
  .map-legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(15, 19, 32, 0.95);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    z-index: 400;
    color: #d1d5db;
    font-size: 12px;
    backdrop-filter: blur(10px);
  }
  .map-legend h4 {
    margin: 0 0 8px 0;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }
  .map-legend .legend-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
  }
  .map-legend .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  /* Mover controles de zoom en pantalla completa */
  .mapwrap.fullscreen .leaflet-control-zoom {
    position: absolute !important;
    bottom: 20px !important;
    right: 20px !important;
    top: auto !important;
    left: auto !important;
  }
  .hint{position:absolute; right:12px; bottom:12px; color:var(--muted); font-size:12px; z-index:400}
  /* Mover hint en pantalla completa para no interferir con zoom */
  .mapwrap.fullscreen .hint {
    bottom: 60px !important;
  }
  
  /* Estilos para el panel de rutas en la parte inferior */
  .routes-panel {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 500;
    width: 60%;
    max-width: 600px;
  }
  
  .routes-toggle {
    width: 100%;
    padding: 8px 12px;
    background: rgba(15, 19, 32, 0.85);
    color: var(--text);
    border: 1px solid var(--grid);
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    backdrop-filter: blur(10px);
  }
  
  .routes-toggle:hover {
    background: var(--panel);
    border-color: var(--accent);
  }
  
  .routes-container {
    display: none;
    background: rgba(15, 19, 32, 0.85);
    border: 1px solid var(--grid);
    border-radius: 12px;
    padding: 12px;
    margin-top: 6px;
    max-height: 40vh;
    overflow-y: auto;
    backdrop-filter: blur(10px);
    transition: opacity 0.3s ease;
  }
  
  .routes-container.open {
    display: block;
    animation: slideUp 0.3s ease-out;
  }
  
  .routes-container.transparent {
    opacity: 0.2;
  }
  
  .routes-container.transparent:hover {
    opacity: 1;
  }
  
  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .routes-header-controls {
    margin-bottom: 8px;
  }
  
  .routes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .routes-header h3 {
    margin: 0;
    font-size: 14px;
    color: var(--text);
    white-space: nowrap;
  }
  
  .transport-mode-selector {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }
  
  .mode-label {
    font-size: 11px;
    color: var(--muted);
    font-weight: 600;
    white-space: nowrap;
  }
  
  .mode-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4px;
    width: 160px;
  }
  
  .mode-button {
    padding: 4px 6px;
    background: var(--chip);
    color: var(--text);
    border: 1px solid var(--grid);
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all 0.2s;
  }
  
  .mode-button.active {
    background: var(--accent);
    color: white;
  }
  
  .clear-route-button {
    padding: 4px 8px;
    background: var(--chip);
    border: 1px solid var(--grid);
    border-radius: 6px;
    color: var(--text);
    cursor: pointer;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .routes-categories {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 8px;
  }
  
  .route-category summary {
    padding: 6px 8px;
    background: var(--chip);
    border: 1px solid var(--grid);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text);
    list-style: none;
    display: flex;
    align-items: center;
  }
  
  .route-category[open] summary {
    background: var(--panel);
    border-color: var(--accent2);
  }
  
  .route-category summary:hover {
    background: var(--panel);
    border-color: var(--accent);
  }
  
  .route-category > div {
    padding: 6px 2px 2px 2px;
    max-height: 150px;
    overflow-y: auto;
  }
  
  .route-button {
    width: 100%;
    padding: 4px 6px;
    margin-bottom: 4px;
    background: var(--panel);
    border: 1px solid var(--grid);
    border-radius: 6px;
    color: var(--text);
    cursor: pointer;
    font-size: 11px;
    text-align: left;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .route-button:hover {
    background: var(--chip);
    /* El color del borde se maneja con JavaScript */
  }
  
  .route-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .route-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .route-arrow {
    color: var(--muted);
    font-size: 10px;
  }
  /* Modal */
  dialog{
    width:min(1400px, 95vw); max-height:90vh; padding:0; border:none; border-radius:16px; overflow:hidden; background:var(--panel); color:var(--text)
  }
  dialog::backdrop{background:rgba(0,0,0,.5); backdrop-filter: blur(2px)}
  .modal-head{padding:16px 18px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--grid)}
  .modal-body{padding:20px; display:grid; gap:16px}
  .modal-body p{margin:0; color:#d7dbea; font-size:14px; line-height:1.5}
  .modal-grid{display:grid; grid-template-columns: 1.5fr 1fr; gap:20px}
  .modal-grid img{width:100%; border-radius:12px; border:1px solid var(--grid)}
  .footer{padding:12px 18px; border-top:1px solid var(--grid); display:flex; justify-content:space-between; align-items:center; color:var(--muted)}
  @media (max-width:1100px){
    .wrap{grid-template-columns:1fr}
    .toolbar{grid-template-columns: 1fr 1fr; grid-auto-rows:auto}
    .card{grid-column: span 6}
  }
  @media (max-width:720px){
    .toolbar{grid-template-columns: 1fr}
    .card{grid-column: span 12}
    .modal-grid{grid-template-columns: 1fr}
    
    /* Mejoras para dispositivos mÃ³viles */
    header h1 { font-size: 16px; }
    header small { font-size: 11px; }
    .logo-image { height: 30px; }
    
    .wrap { grid-template-columns: 1fr; }
    aside { width: 100%; max-width: none; }
    
    .map-controls { right: 8px; gap: 4px; }
    .map-controls button, .map-controls select { padding: 6px 8px; font-size: 11px; }
    
    .routes-container { width: 100%; max-width: none; }
    .routes-toggle { width: calc(100% - 16px); }
    
    /* Ajustes para controles del mapa */
    .maplibregl-ctrl-top-left .maplibregl-ctrl { margin: 5px 0 0 5px; }
    .maplibregl-ctrl-group button { width: 26px; height: 26px; }
  }
  @media (min-width:1600px){
    dialog{
      width:min(1600px, 90vw);
    }
    .modal-grid{
      grid-template-columns: 2fr 1fr;
    }
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* ANIMACIONES PARA RUTAS                                                     */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
  
  /* Estilos para desplegables de rutas y categorÃ­as */
  details.route-category summary::-webkit-details-marker,
  details.place-category summary::-webkit-details-marker {
    display: none;
  }
  
  details.route-category[open] summary,
  details.place-category[open] summary {
    background: var(--panel);
    border-color: var(--accent2);
  }
  
  details.route-category summary:hover,
  details.place-category summary:hover {
    background: var(--panel);
    border-color: var(--accent);
  }
  
  /* Indicador de apertura para desplegables del sidebar principal */
  details.place-category summary::before {
    content: 'â–¶';
    display: inline-block;
    margin-right: 8px;
    font-size: 10px;
    transition: transform 0.2s;
  }
  
  details.place-category[open] summary::before {
    transform: rotate(90deg);
  }
  
  /* Estilo para items de lugar */
  .place-item:active {
    transform: scale(0.98);
  }
  
  /* Mejoras para interacciÃ³n tÃ¡ctil */
  @media (pointer: coarse) {
    /* Aumentar Ã¡rea de toque para elementos interactivos */
    button, .chip, .place-item, .route-button, summary {
      min-height: 44px;
    }
    
    /* Aumentar espacio entre elementos tÃ¡ctiles */
    .place-item, .route-button {
      margin-bottom: 8px;
      padding: 10px 12px;
    }
    
    /* Mejorar visibilidad de elementos activos */
    button:active, .chip:active, .place-item:active, .route-button:active {
      opacity: 0.7;
    }
  }
</style>

<!-- MapLibre GL JS para mapas 3D -->
<script src='https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css' rel='stylesheet' />
</head>
<body>
<header>
  <div class="header-content-left">
    <div class="header-logo">
      <img src="Logo.png" alt="INFINITY Nova Logo" class="logo-image">
    </div>
    <div class="header-left">
      <h1>INFINITY Nova â€” Urban & Delta Legal Division</h1>
      <small>Analisis de Mercado Inmobiliario en Calle Oliver 56, en Alcoy (Alicante)</small>
    </div>
  </div>
  <div class="header-right">
    <a href="https://infinitynova.xyz" target="_blank" class="domain">infinitynova.xyz</a>
  </div>
</header>

<div class="wrap">
  <aside>
    <h4 style="margin-bottom:10px;">ğŸ“ Emplazamientos</h4>
    <p style="font-size:11px;color:var(--muted);margin:0 0 12px 0;line-height:1.4;">Explora lugares clave organizados por categorÃ­a</p>
    
    <!-- Desplegables por categorÃ­a -->
    <div id="places-categories" style="margin-bottom:16px;">
      
      <!-- Objetivo -->
      <details class="place-category" open style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#60a5fa;margin-right:8px;">â—</span> ğŸ¯ Objetivo
        </summary>
        <div id="cat-objetivo" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
      <!-- Universidades -->
      <details class="place-category" style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#f472b6;margin-right:8px;">â—</span> ğŸ›ï¸ Universidades
        </summary>
        <div id="cat-universidad" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
      <!-- Salud -->
      <details class="place-category" style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#ef4444;margin-right:8px;">â—</span> ğŸ¥ Salud
        </summary>
        <div id="cat-salud" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
      <!-- Comercio -->
      <details class="place-category" style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#f59e0b;margin-right:8px;">â—</span> ğŸ›ï¸ Supermercados
        </summary>
        <div id="cat-comercio" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
      <!-- Servicios -->
      <details class="place-category" style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#34d399;margin-right:8px;">â—</span> ğŸ½ï¸ Servicios
        </summary>
        <div id="cat-servicios" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
      <!-- Transporte -->
      <details class="place-category" style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#06b6d4;margin-right:8px;">â—</span> ğŸšŒ Transporte
        </summary>
        <div id="cat-transporte" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
      <!-- Cultura/Parque -->
      <details class="place-category" style="margin-bottom:8px;">
        <summary style="padding:10px 12px;background:var(--chip);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text);list-style:none;font-weight:600;">
          <span style="color:#a78bfa;margin-right:8px;">â—</span> ğŸ­ Cultura y Ocio
        </summary>
        <div id="cat-cultura" style="padding:8px 4px 4px 12px;"></div>
      </details>
      
    </div>

    <div class="viewtabs">      
      <div class="tab" data-view="map" data-active="true">Vista mapa</div>
      <div class="tab" data-view="grid">AnÃ¡lisis & Insights</div>
    </div>
  </aside>

  <main>
    <section id="grid" class="grid hidden"></section>

    <section id="mapview" class="mapwrap">
      <div id="map" aria-label="Mapa interactivo"></div>
      <div class="hint">Pulsa un punto para ver la imagen y descargarla. Activa 3D para ver edificios en perspectiva.</div>
      
      <!-- Leyenda de categorÃ­as -->
      <div class="map-legend">
        <div class="legend-row"><span class="legend-dot" style="background:#60a5fa"></span> Objetivo</div>
        <div class="legend-row"><span class="legend-dot" style="background:#f472b6"></span> Universidad</div>
        <div class="legend-row"><span class="legend-dot" style="background:#ef4444"></span> Salud</div>
        <div class="legend-row"><span class="legend-dot" style="background:#f59e0b"></span> Comercio</div>
        <div class="legend-row"><span class="legend-dot" style="background:#34d399"></span> Servicios</div>
        <div class="legend-row"><span class="legend-dot" style="background:#06b6d4"></span> Transporte</div>
        <div class="legend-row"><span class="legend-dot" style="background:#a78bfa"></span> Cultura / Parque</div>
      </div>
      
      <!-- Desplegable de rutas en la parte inferior del mapa -->
      <div class="routes-panel">
        <button id="routes-toggle" class="routes-toggle">ğŸ›£ï¸ Rutas desde Oliver 56</button>
        <div id="routes-container" class="routes-container">
          <div class="routes-header-controls">
            <div class="routes-header">
              <h3>ğŸ›£ï¸ Rutas</h3>
              <div class="transport-mode-selector">
                <div class="mode-label">Modo:</div>
                <div class="mode-buttons">
                  <button id="route-mode-foot" onclick="setRouteMode('foot')" class="mode-button active">
                    <span>ğŸš¶</span> Peatonal
                  </button>
                  <button id="route-mode-driving" onclick="setRouteMode('driving')" class="mode-button">
                    <span>ğŸš—</span> VehÃ­culo
                  </button>
                </div>
                <button onclick="clearRoute(map)" class="clear-route-button">ğŸ§¹</button>
              </div>
            </div>
          </div>
          
          <div class="routes-categories">
            <!-- CategorÃ­a: Universidades -->
            <details class="route-category">
              <summary>
                <span style="color:#f472b6;margin-right:6px;">â—</span> Universidades
              </summary>
              <div id="routes-universidad"></div>
            </details>
            
            <!-- CategorÃ­a: Salud -->
            <details class="route-category">
              <summary>
                <span style="color:#ef4444;margin-right:6px;">â—</span> Salud
              </summary>
              <div id="routes-salud"></div>
            </details>
            
            <!-- CategorÃ­a: Supermercados -->
            <details class="route-category">
              <summary>
                <span style="color:#f59e0b;margin-right:6px;">â—</span> Supermercados
              </summary>
              <div id="routes-comercio"></div>
            </details>
            
            <!-- CategorÃ­a: Transporte -->
            <details class="route-category">
              <summary>
                <span style="color:#06b6d4;margin-right:6px;">â—</span> Transporte
              </summary>
              <div id="routes-transporte"></div>
            </details>
            
            <!-- CategorÃ­a: Cultura y Ocio -->
            <details class="route-category">
              <summary>
                <span style="color:#a78bfa;margin-right:6px;">â—</span> Cultura y Ocio
              </summary>
              <div id="routes-cultura"></div>
            </details>
          </div>
        </div>
      </div>
      
      <!-- Panel de control 3D -->
      <div id="control-panel-3d" class="control-panel-3d" style="display:none">
        <h4 style="margin:0 0 8px 0; font-size:12px; color:#ddd">Controles 3D</h4>
        <label style="display:block; font-size:11px; margin-bottom:4px; color:#bbb">
          Altura edificios: <span id="extrusion-value">1.0</span>x
          <input id="extrusion-slider" type="range" min="0.5" max="3" step="0.1" value="1.0" style="width:100%; margin-top:2px">
        </label>
        <label style="display:block; font-size:11px; margin-bottom:4px; color:#bbb">
          IluminaciÃ³n: <span id="light-value">0.4</span>
          <input id="light-slider" type="range" min="0.1" max="1" step="0.05" value="0.4" style="width:100%; margin-top:2px">
        </label>
        <label style="display:block; font-size:11px; margin-bottom:4px; color:#bbb">
          InclinaciÃ³n: <span id="pitch-value">60</span>Â°
          <input id="pitch-slider" type="range" min="0" max="85" step="1" value="60" style="width:100%; margin-top:2px">
        </label>
        <label style="display:block; font-size:11px; color:#bbb">
          RotaciÃ³n: <span id="bearing-value">0</span>Â°
          <input id="bearing-slider" type="range" min="0" max="360" step="1" value="0" style="width:100%; margin-top:2px">
        </label>
      </div>
      
      <!-- Sidebar para filtros en pantalla completa -->
      <div id="map-sidebar" class="map-sidebar">
        <h3 style="margin:6px 0 8px 0; color:var(--text)">Filtros</h3>
        
        <h4>BÃºsqueda</h4>
        <input id="q-fullscreen" type="search" placeholder="Buscar...">
        
        <h4>Demanda</h4>
        <div class="chips" id="chips-precios-fullscreen"></div>
        
        <h4>Tipos</h4>
        <div class="chips" id="chips-tipos-fullscreen"></div>
        
        <h4>UbicaciÃ³n</h4>
        <div class="chips" id="chips-dominio-fullscreen"></div>
        
        <h4>Tipo de Mapa</h4>
        <select id="map-type-fullscreen">
          <option value="grayscale" selected>Positron (3D Ã³ptimo)</option>
          <option value="topographic">TopogrÃ¡fico</option>
          <option value="satellite">SatÃ©lite</option>
        </select>
        
        <!-- Se eliminÃ³ el contenido de rutas del sidebar -->
        
        <!-- Contenido del sidebar sin las rutas -->
        <!-- Las rutas se han movido al panel inferior -->
        
      </div>
      
      <!-- BotÃ³n de filtros eliminado -->
      
      <!-- Controles del mapa -->
      <div class="map-controls">
        <select id="map-type-normal">
          <option value="grayscale" selected>Positron (3D Ã³ptimo)</option>
          <option value="topographic">TopogrÃ¡fico</option>
          <option value="satellite">SatÃ©lite</option>
        </select>
        <button id="toggle-3d-btn">Activar 3D</button>
        <div class="rotation-controls" id="rotation-controls">
          <button id="rotate-left">â†¶ Rotar Izq</button>
          <button id="rotate-right">â†· Rotar Der</button>
          <button id="reset-rotation">âŠ™ Reset</button>
        </div>
        <button id="fullscreen-btn">Pantalla completa</button>
        <button id="exit-fullscreen-btn" style="display:none;">Salir pantalla completa</button>
      </div>
    </section>
  </main>
</div>

<dialog id="modal">
  <div class="modal-head">
    <strong id="m-title">Detalle</strong>
    <button onclick="modal.close()">Cerrar</button>
  </div>
  <div class="modal-body">
    <div class="modal-grid">
      <img id="m-img" alt="Vista seleccionada"/>
      <div>
        <p id="m-desc"></p>
        <div class="meta" id="m-meta"></div>
      </div>
    </div>
  </div>
  <div class="footer">
    <span id="m-note">Descarga la imagen en alta calidad.</span>
    <div>
      <a id="btn-download" class="button primary" href="#" download>Descargar</a>
    </div>
  </div>
</dialog>

<script>
  // ============================================================================
  // DATOS DE EMPLAZAMIENTOS (de oliver56_fichas_mapa_interactivo.html)
  // ============================================================================
  const PLACES = [
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OBJETIVO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "oliver56",
      nombre: "Parcela objetivo â€” C/ Oliver, 56 (APROX)",
      categoria: "Objetivo",
      direccion: "C/ Oliver, 56, 03802 Alcoi",
      lat: 38.692482, lon: -0.488495,
      etiquetas: ["Student Living", "Bajo comercial", "Ref. Cat. 8658801YH1885N0123PF"],
      resumen: "Solar/obra para dos edificios residenciales (~45 mÂ²/unidad) orientados a estudiantes. Bajo comercial de conveniencia en toda la parcela.",
      nota: "Coordenada aproximada. Verificar con la referencia catastral indicada."
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UNIVERSIDADES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "upv-campus",
      nombre: "Campus d'Alcoi (UPV) â€” FerrÃ¡ndiz i Carbonell",
      categoria: "Universidad",
      direccion: "PlaÃ§a FerrÃ¡ndiz i Carbonell, s/n",
      lat: 38.698889, lon: -0.469167,
      etiquetas: ["IngenierÃ­as", "Servicios campus", "Estudiantes 2.7â€“2.9k"],
      resumen: "Campus principal de la UPV en Alcoy. Polo de atracciÃ³n estudiantil y generador de demanda residencial.",
      nota: "Punto de acceso principal histÃ³rico."
    },
    {
      id: "upv-georgina",
      nombre: "Edificio/PabellÃ³n Georgina Blanes (UPV)",
      categoria: "Universidad",
      direccion: "C/ AlarcÃ³n, 1",
      lat: 38.694125, lon: -0.477267,
      etiquetas: ["Deporte", "Pistas", "Aparcamiento"],
      resumen: "InstalaciÃ³n deportiva universitaria con pabellÃ³n y pistas, refuerza el atractivo para estudiantes.",
      nota: ""
    },
    {
      id: "easd-alcoi",
      nombre: "EASD d'Alcoi (Escuela de Arte)",
      categoria: "Universidad",
      direccion: "C/ Rigoberto Albors",
      lat: 38.69891, lon: -0.47122,
      etiquetas: ["Arte", "DiseÃ±o"],
      resumen: "Escuela de Arte y DiseÃ±o de Alcoy.",
      nota: ""
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SALUD (Hospitales y Centros de Salud)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "imed",
      nombre: "Hospital IMED San Jorge (privado)",
      categoria: "Salud",
      direccion: "C/ Oliver, 55",
      lat: 38.692820, lon: -0.485940,
      etiquetas: ["Hospital privado", "Urgencias 24h", "Servicios sanitarios"],
      resumen: "Hospital general frente a la parcela objetivo. Aporta seguridad percibida y servicios.",
      nota: ""
    },
    {
      id: "hospital-verge",
      nombre: "Hospital Verge dels Lliris (pÃºblico)",
      categoria: "Salud",
      direccion: "PlaÃ§a de l'Hospital, s/n",
      lat: 38.705246, lon: -0.465660,
      etiquetas: ["Hospital pÃºblico", "Urgencias", "Referencia provincial"],
      resumen: "Hospital de referencia pÃºblico en Alcoy, perteneciente al sistema sanitario valenciano.",
      nota: ""
    },
    {
      id: "cs-fabrica",
      nombre: "Centro de Salud La FÃ brica",
      categoria: "Salud",
      direccion: "C/ Sant Blai",
      lat: 38.696710, lon: -0.480990,
      etiquetas: ["AtenciÃ³n primaria", "Centro de salud"],
      resumen: "Centro de atenciÃ³n primaria en zona oeste.",
      nota: ""
    },
    {
      id: "cs-bassa",
      nombre: "Centro de Salud La Bassa",
      categoria: "Salud",
      direccion: "Avda. Juan Gil-Albert",
      lat: 38.708050, lon: -0.469190,
      etiquetas: ["AtenciÃ³n primaria", "Centro de salud"],
      resumen: "Centro de atenciÃ³n primaria en zona norte.",
      nota: ""
    },
    {
      id: "cs-placa-dins",
      nombre: "Centro de Salud PlaÃ§a de Dins",
      categoria: "Salud",
      direccion: "PlaÃ§a de Dins",
      lat: 38.697990, lon: -0.473440,
      etiquetas: ["AtenciÃ³n primaria", "Centro histÃ³rico"],
      resumen: "Centro de atenciÃ³n primaria en el centro histÃ³rico.",
      nota: ""
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FARMACIAS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "farmacia-campanar",
      nombre: "Farmacia del Campanar",
      categoria: "Salud",
      direccion: "C/ del Campanar",
      lat: 38.698560, lon: -0.473030,
      etiquetas: ["Farmacia", "24h"],
      resumen: "Farmacia en zona centro.",
      nota: ""
    },
    {
      id: "farmacia-cami",
      nombre: "FarmÃ cia El CamÃ­",
      categoria: "Salud",
      direccion: "C/ El CamÃ­, 58",
      lat: 38.691990, lon: -0.475940,
      etiquetas: ["Farmacia"],
      resumen: "Farmacia en zona sur.",
      nota: ""
    },
    {
      id: "farmacia-alameda",
      nombre: "Farmacia Alameda",
      categoria: "Salud",
      direccion: "Alameda, 53",
      lat: 38.702770, lon: -0.476580,
      etiquetas: ["Farmacia"],
      resumen: "Farmacia en la zona de la Alameda.",
      nota: ""
    },
    {
      id: "farmacia-viaducto",
      nombre: "Farmacia Viaducto",
      categoria: "Salud",
      direccion: "Passeig Ovidi Montllor",
      lat: 38.697550, lon: -0.468190,
      etiquetas: ["Farmacia"],
      resumen: "Farmacia cerca del viaducto.",
      nota: ""
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMERCIO (Supermercados y Centros Comerciales)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "alzamora",
      nombre: "Centro Comercial Alzamora",
      categoria: "Comercio",
      direccion: "C/ Els AlÃ§amora, 44",
      lat: 38.6974895, lon: -0.4805929,
      etiquetas: ["Retail", "RestauraciÃ³n", "Cines"],
      resumen: "Principal centro comercial de la ciudad: compras, restauraciÃ³n y ocio.",
      nota: ""
    },
    {
      id: "lidl-valencia",
      nombre: "Lidl",
      categoria: "Comercio",
      direccion: "C/ ValÃ¨ncia, 2",
      lat: 38.710630, lon: -0.466920,
      etiquetas: ["Supermercado", "Descuento"],
      resumen: "Supermercado en acceso norte de la ciudad.",
      nota: ""
    },
    {
      id: "aldi",
      nombre: "ALDI",
      categoria: "Comercio",
      direccion: "C/ Juan Gil Albert, 34",
      lat: 38.708805, lon: -0.4690949,
      etiquetas: ["Supermercado", "Descuento"],
      resumen: "Supermercado de descuento en zona norte.",
      nota: ""
    },
    {
      id: "mercadona",
      nombre: "Mercadona",
      categoria: "Comercio",
      direccion: "C/ Santa Rosa, 7",
      lat: 38.697678, lon: -0.48337585,
      etiquetas: ["Supermercado"],
      resumen: "Supermercado de proximidad.",
      nota: ""
    },
    {
      id: "masymas-sabadell",
      nombre: "masymas",
      categoria: "Comercio",
      direccion: "C/ Sabadell, 21",
      lat: 38.7083396912, lon: -0.4664107561,
      etiquetas: ["Supermercado"],
      resumen: "Supermercado regional.",
      nota: ""
    },
    {
      id: "masymas-botella",
      nombre: "masymas",
      categoria: "Comercio",
      direccion: "Pl. Evaristo Botella, 1",
      lat: 38.695000, lon: -0.484167,
      etiquetas: ["Supermercado"],
      resumen: "Supermercado regional en el centro.",
      nota: ""
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSPORTE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "estacion-autobuses",
      nombre: "EstaciÃ³n de Autobuses de Alcoy",
      categoria: "Transporte",
      direccion: "Avda. Joan Gil Albert",
      lat: 38.709690, lon: -0.468950,
      etiquetas: ["AutobÃºs", "Transporte interurbano"],
      resumen: "EstaciÃ³n central de autobuses con conexiones regionales.",
      nota: ""
    },
    {
      id: "estacion-renfe",
      nombre: "EstaciÃ³n de tren (RENFE) - Alcoi",
      categoria: "Transporte",
      direccion: "Passeig del Viaducte",
      lat: 38.709470, lon: -0.470236,
      etiquetas: ["Tren", "RENFE", "CercanÃ­as"],
      resumen: "EstaciÃ³n de tren con servicios regionales.",
      nota: ""
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SERVICIOS Y RESTAURACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "bar-deportivo",
      nombre: "Bar Deportivo",
      categoria: "Servicios",
      direccion: "C/ Oliver, 36",
      lat: 38.693100, lon: -0.485972,
      etiquetas: ["RestauraciÃ³n", "Proximidad"],
      resumen: "OpciÃ³n de restauraciÃ³n casual a pocos metros del solar.",
      nota: ""
    },
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CULTURA, OCIO Y PARQUES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    {
      id: "teatre-calderon",
      nombre: "Teatre CalderÃ³n",
      categoria: "Cultura/Parque",
      direccion: "PlaÃ§a d'Espanya, 14",
      lat: 38.69738, lon: -0.47265,
      etiquetas: ["Cultura", "Teatro"],
      resumen: "Equipamiento cultural emblemÃ¡tico de Alcoy.",
      nota: ""
    },
    {
      id: "parc-glorieta",
      nombre: "Parque de La Glorieta",
      categoria: "Cultura/Parque",
      direccion: "PlaÃ§a de RamÃ³n y Cajal",
      lat: 38.69603, lon: -0.47347,
      etiquetas: ["Parque", "Zona verde"],
      resumen: "Espacio verde histÃ³rico del centro.",
      nota: ""
    },
    {
      id: "passeig-cervantes",
      nombre: "Passeig de Cervantes",
      categoria: "Cultura/Parque",
      direccion: "Passeig de Cervantes",
      lat: 38.69764, lon: -0.47742,
      etiquetas: ["Parque", "Paseo"],
      resumen: "Paseo arbolado y zona verde en el centro.",
      nota: ""
    },
    {
      id: "placa-espanya",
      nombre: "PlaÃ§a d'Espanya",
      categoria: "Cultura/Parque",
      direccion: "PlaÃ§a d'Espanya",
      lat: 38.697857, lon: -0.473111,
      etiquetas: ["Plaza", "Centro histÃ³rico"],
      resumen: "Plaza principal del centro histÃ³rico.",
      nota: ""
    },
    {
      id: "ivam-cada",
      nombre: "IVAM CADA Alcoi (Museo)",
      categoria: "Cultura/Parque",
      direccion: "C/ Rigoberto Albors",
      lat: 38.69733, lon: -0.47149,
      etiquetas: ["Museo", "Arte contemporÃ¡neo"],
      resumen: "Museo de arte contemporÃ¡neo.",
      nota: ""
    },
    {
      id: "polideportivo",
      nombre: "Polideportivo Francisco Laporta",
      categoria: "Cultura/Parque",
      direccion: "Avda. d'Alcoi",
      lat: 38.71958, lon: -0.47098,
      etiquetas: ["Deporte", "Instalaciones"],
      resumen: "Polideportivo municipal con instalaciones deportivas.",
      nota: ""
    }
  ];

  // Colores por categorÃ­a para marcadores
  const CAT_COLORS = {
    "Objetivo": "#60a5fa",        // Azul
    "Universidad": "#f472b6",     // Rosa
    "Salud": "#ef4444",           // Rojo
    "Comercio": "#f59e0b",        // Naranja
    "Servicios": "#34d399",       // Verde
    "Cultura/Parque": "#a78bfa",  // PÃºrpura
    "Cultura / Parque": "#a78bfa", // Alias con espacios
    "Transporte": "#06b6d4"       // Cyan
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SISTEMA DE RUTAS (OSRM)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let currentRouteLayer = null;
  let routeAnimationId = null;
  let routeMode = 'foot'; // 'foot' (peatonal) o 'driving' (vehÃ­culo)
  
  // Colores por modo de transporte
  const ROUTE_COLORS = {
    'foot': '#10b981',      // Verde para peatonal
    'driving': '#3b82f6'    // Azul para vehÃ­culo
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RUTAS PEATONALES PREDEFINIDAS (Desde Google Maps)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const PREDEFINED_PEDESTRIAN_ROUTES = {
    'oliver56-to-upv-campus': {
      // Ruta peatonal: 1.4 km, 19 min (Google Maps)
      coordinates: [
        [-0.4859, 38.6929],    // Oliver 56 (origen)
        [-0.4857, 38.6932],    // C/ Oliver norte
        [-0.4853, 38.6938],    // ContinuaciÃ³n C/ Oliver
        [-0.4848, 38.6945],    // Girando hacia el este
        [-0.4842, 38.6948],    // Cruce importante
        [-0.4835, 38.6952],    // Zona Supermercado Consum
        [-0.4828, 38.6955],    // Subiendo hacia el campus
        [-0.4820, 38.6960],    // Zona residencial
        [-0.4812, 38.6965],    // AcercÃ¡ndose al campus
        [-0.4805, 38.6970],    // Zona norte
        [-0.4798, 38.6975],    // Entrada zona universitaria
        [-0.4790, 38.6980],    // Dentro del Ã¡rea universitaria
        [-0.4782, 38.6983],    // Zona de facultades
        [-0.4775, 38.6986],    // Cerca del acceso principal
        [-0.469167, 38.698889] // Campus UPV (destino)
      ],
      distance: 1400,  // metros (desde Google Maps)
      duration: 1140,  // segundos (19 min)
      source: 'Google Maps - Captura del usuario'
    },
    'oliver56-to-imed': {
      // Ruta peatonal: 210m, 3 min (Google Maps)
      // Ruta MUY corta - el hospital estÃ¡ prÃ¡cticamente enfrente
      coordinates: [
        [-0.4859, 38.6929],    // Oliver 56 (origen)
        [-0.4859, 38.69282],   // Saliendo del edificio
        [-0.4859, 38.69275],   // Cruzando la calle
        [-0.48594, 38.6928],   // Llegando al hospital
        [-0.485940, 38.692820] // Hospital IMED (destino)
      ],
      distance: 210,   // metros (desde Google Maps)
      duration: 180,   // segundos (3 min)
      source: 'Google Maps - Captura del usuario'
    },
    'oliver56-to-alzamora': {
      // Ruta peatonal: 950m, 13 min (Google Maps)
      coordinates: [
        [-0.4859, 38.6929],    // Oliver 56 (origen)
        [-0.4858, 38.6930],    // C/ Oliver
        [-0.4856, 38.6933],    // Continuando por Oliver
        [-0.4854, 38.6936],    // Hacia el norte
        [-0.4852, 38.6939],    // Zona Supermercado Consum
        [-0.4850, 38.6942],    // Subiendo
        [-0.4847, 38.6945],    // Cruce importante
        [-0.4844, 38.6948],    // Girando hacia C/ dels AlÃ§amora
        [-0.4841, 38.6951],    // C/ dels AlÃ§amora
        [-0.4838, 38.6955],    // Continuando norte
        [-0.4835, 38.6958],    // Subiendo hacia el centro
        [-0.4832, 38.6962],    // Zona comercial
        [-0.4829, 38.6966],    // Acercamiento
        [-0.4826, 38.6970],    // PrÃ³ximo al centro
        [-0.4823, 38.6972],    // Llegando
        [-0.4805929, 38.6974895] // Centro Comercial Alzamora (destino)
      ],
      distance: 950,   // metros (desde Google Maps)
      duration: 780,   // segundos (13 min)
      source: 'Google Maps - Captura del usuario'
    },
    'oliver56-to-estacion-autobuses': {
      // Ruta peatonal: 2.6 km, 36 min (Google Maps)
      // Ruta larga atravesando la ciudad hacia el norte
      coordinates: [
        [-0.4859, 38.6929],    // Oliver 56 (origen)
        [-0.4858, 38.6932],    // C/ Oliver norte
        [-0.4856, 38.6936],    // Continuando Oliver
        [-0.4854, 38.6940],    // Zona Supermercado Consum
        [-0.4852, 38.6944],    // Subiendo
        [-0.4850, 38.6948],    // Hacia la zona central
        [-0.4847, 38.6952],    // Cruce importante
        [-0.4844, 38.6956],    // Zona residencial
        [-0.4841, 38.6960],    // Continuando norte
        [-0.4838, 38.6964],    // Plaza de EspaÃ±a zona
        [-0.4835, 38.6968],    // Centro histÃ³rico
        [-0.4832, 38.6972],    // Zona comercial
        [-0.4829, 38.6976],    // Subiendo hacia zona norte
        [-0.4826, 38.6980],    // Zona alta de la ciudad
        [-0.4823, 38.6984],    // Continuando ascenso
        [-0.4820, 38.6988],    // Zona industrial/norte
        [-0.4817, 38.6992],    // Acercamiento estaciÃ³n
        [-0.4814, 38.6996],    // Zona de transporte
        [-0.4811, 38.7000],    // PrÃ³ximo a estaciÃ³n
        [-0.4808, 38.7004],    // Entrando zona estaciÃ³n
        [-0.4805, 38.7008],    // Llegando
        [-0.468950, 38.709690] // EstaciÃ³n de Autobuses (destino)
      ],
      distance: 2600,  // metros (desde Google Maps)
      duration: 2160,  // segundos (36 min)
      source: 'Google Maps - Captura del usuario'
    },
    'oliver56-to-estacion-renfe': {
      // Ruta peatonal: 2.6 km, 36 min (Google Maps)
      // Ruta similar a estaciÃ³n autobuses (muy cercanas)
      coordinates: [
        [-0.4859, 38.6929],    // Oliver 56 (origen)
        [-0.4858, 38.6932],    // C/ Oliver norte
        [-0.4856, 38.6936],    // Continuando Oliver
        [-0.4854, 38.6940],    // Zona Supermercado Consum
        [-0.4852, 38.6944],    // Subiendo
        [-0.4850, 38.6948],    // Hacia la zona central
        [-0.4847, 38.6952],    // Cruce importante
        [-0.4844, 38.6956],    // Zona residencial
        [-0.4841, 38.6960],    // Continuando norte
        [-0.4838, 38.6964],    // Plaza de EspaÃ±a zona
        [-0.4835, 38.6968],    // Centro histÃ³rico
        [-0.4832, 38.6972],    // Zona comercial
        [-0.4829, 38.6976],    // Subiendo hacia zona norte
        [-0.4826, 38.6980],    // Zona alta de la ciudad
        [-0.4823, 38.6984],    // Continuando ascenso
        [-0.4820, 38.6988],    // Zona industrial/norte
        [-0.4817, 38.6992],    // Acercamiento estaciÃ³n
        [-0.4814, 38.6996],    // Zona de transporte
        [-0.4811, 38.7000],    // PrÃ³ximo a estaciÃ³n
        [-0.4808, 38.7004],    // Entrando zona estaciÃ³n
        [-0.4803, 38.7009],    // Hacia estaciÃ³n tren
        [-0.470236, 38.709470] // EstaciÃ³n RENFE (destino)
      ],
      distance: 2600,  // metros (desde Google Maps)
      duration: 2160,  // segundos (36 min)
      source: 'Google Maps - Captura del usuario'
    }
    // AÃ±adir mÃ¡s rutas peatonales aquÃ­ a medida que se proporcionen...
  };
  
  // Obtener ruta peatonal predefinida
  function getPedestrianRoute(fromId, toId) {
    const routeKey = `${fromId}-to-${toId}`;
    const route = PREDEFINED_PEDESTRIAN_ROUTES[routeKey];
    
    if (route) {
      console.log(`âœ… Usando ruta PEATONAL predefinida: ${routeKey}`);
      console.log(`   ğŸ“ Fuente: ${route.source}`);
      console.log(`   ğŸ“ ${route.distance}m en ${Math.round(route.duration/60)} minutos`);
      return {
        ...route,
        mode: 'foot',
        isPredefined: true
      };
    }
    
    return null;
  }
  
  // Obtener lugares por categorÃ­a
  function getPlacesByCategory(category) {
    return PLACES.filter(p => p.categoria === category && p.id !== 'oliver56');
  }
  
  // Cambiar modo de ruta
  function setRouteMode(mode) {
    routeMode = mode;
    console.log(`ğŸ”„ Modo de ruta cambiado a: ${mode === 'foot' ? 'ğŸš¶ Peatonal' : 'ğŸš— VehÃ­culo'}`);
    
    // Actualizar UI del selector
    const footBtn = document.getElementById('route-mode-foot');
    const drivingBtn = document.getElementById('route-mode-driving');
    
    if (footBtn && drivingBtn) {
      if (mode === 'foot') {
        footBtn.classList.add('active');
        drivingBtn.classList.remove('active');
      } else {
        drivingBtn.classList.add('active');
        footBtn.classList.remove('active');
      }
    }
  }
  
  // Calcular ruta usando OpenRouteService (mejor para diferenciar peatonal/vehicular)
  async function calculateRoute(fromLon, fromLat, toLon, toLat, mode = null) {
    // Usar el modo explÃ­cito o el modo global actual
    const activeMode = mode || routeMode;
    
    // Mapear modos a perfiles de OpenRouteService
    const profileMap = {
      'foot': 'foot-walking',
      'driving': 'driving-car'
    };
    
    const profile = profileMap[activeMode] || 'foot-walking';
    
    try {
      // Intentar primero con OpenRouteService (gratuito, sin API key para pruebas)
      const url = `https://api.openrouteservice.org/v2/directions/${profile}?start=${fromLon},${fromLat}&end=${toLon},${toLat}`;
      
      console.log(`ğŸŒ Calculando ruta con OpenRouteService`);
      console.log(`ğŸ“ Modo: ${activeMode} (perfil: ${profile})`);
      console.log(`ğŸ”— URL: ${url}`);
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.features && data.features.length > 0) {
        const route = data.features[0];
        const coords = route.geometry.coordinates;
        const distance = route.properties.segments[0].distance; // metros
        const duration = route.properties.segments[0].duration; // segundos
        
        console.log(`âœ… Ruta OpenRouteService recibida para modo '${activeMode}':`);
        console.log(`   - Distancia: ${distance}m`);
        console.log(`   - DuraciÃ³n: ${duration}s`);
        console.log(`   - Puntos en ruta: ${coords.length}`);
        
        return {
          coordinates: coords,
          distance: distance,
          duration: duration,
          mode: activeMode
        };
      } else {
        throw new Error('No se encontrÃ³ ruta en la respuesta');
      }
    } catch (error) {
      console.warn('âš ï¸ OpenRouteService fallÃ³, intentando con OSRM...', error);
      
      // Fallback a OSRM si OpenRouteService falla
      try {
        const osrmUrl = `https://router.project-osrm.org/route/v1/${activeMode}/${fromLon},${fromLat};${toLon},${toLat}?overview=full&geometries=geojson`;
        
        console.log(`ğŸ”„ Fallback a OSRM: ${osrmUrl}`);
        
        const response = await fetch(osrmUrl);
        const data = await response.json();
        
        if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
          throw new Error('OSRM tambiÃ©n fallÃ³');
        }
        
        console.log(`âœ… Ruta OSRM recibida (fallback):`);
        console.log(`   - Distancia: ${data.routes[0].distance}m`);
        console.log(`   - DuraciÃ³n: ${data.routes[0].duration}s`);
        
        return {
          coordinates: data.routes[0].geometry.coordinates,
          distance: data.routes[0].distance,
          duration: data.routes[0].duration,
          mode: activeMode
        };
      } catch (osrmError) {
        console.error('âŒ Ambos servicios fallaron:', osrmError);
        return null;
      }
    }
  }
  
  // Animar ruta en el mapa
  function animateRoute(map, coordinates, color = '#ff2d55') {
    if (!coordinates || coordinates.length < 2) return;
    
    // Limpiar ruta anterior
    if (currentRouteLayer) {
      if (map.getLayer('route-line')) map.removeLayer('route-line');
      if (map.getLayer('route-marker')) map.removeLayer('route-marker');
      if (map.getSource('route')) map.removeSource('route');
      if (map.getSource('route-marker')) map.removeSource('route-marker');
      if (routeAnimationId) cancelAnimationFrame(routeAnimationId);
    }
    
    // AÃ±adir source y layer para la ruta
    map.addSource('route', {
      'type': 'geojson',
      'data': {
        'type': 'Feature',
        'properties': {},
        'geometry': {
          'type': 'LineString',
          'coordinates': []
        }
      }
    });
    
    map.addLayer({
      'id': 'route-line',
      'type': 'line',
      'source': 'route',
      'layout': {
        'line-join': 'round',
        'line-cap': 'round'
      },
      'paint': {
        'line-color': color,
        'line-width': 4,
        'line-opacity': 0.8
      }
    });
    
    // Marcador animado
    map.addSource('route-marker', {
      'type': 'geojson',
      'data': {
        'type': 'Feature',
        'geometry': {
          'type': 'Point',
          'coordinates': coordinates[0]
        }
      }
    });
    
    map.addLayer({
      'id': 'route-marker',
      'type': 'circle',
      'source': 'route-marker',
      'paint': {
        'circle-radius': 8,
        'circle-color': color,
        'circle-stroke-width': 3,
        'circle-stroke-color': '#ffffff'
      }
    });
    
    // Ajustar vista a la ruta
    const bounds = coordinates.reduce((bounds, coord) => {
      return bounds.extend(coord);
    }, new maplibregl.LngLatBounds(coordinates[0], coordinates[0]));
    
    map.fitBounds(bounds, { padding: 80, duration: 1000 });
    
    // Animar la ruta
    let step = 0;
    const totalSteps = coordinates.length;
    const animationSpeed = 30; // ms por paso
    
    function animate() {
      if (step >= totalSteps) {
        currentRouteLayer = true;
        return;
      }
      
      // Actualizar lÃ­nea
      const lineCoords = coordinates.slice(0, step + 1);
      map.getSource('route').setData({
        'type': 'Feature',
        'geometry': {
          'type': 'LineString',
          'coordinates': lineCoords
        }
      });
      
      // Actualizar marcador
      map.getSource('route-marker').setData({
        'type': 'Feature',
        'geometry': {
          'type': 'Point',
          'coordinates': coordinates[step]
        }
      });
      
      step++;
      routeAnimationId = setTimeout(animate, animationSpeed);
    }
    
    animate();
    currentRouteLayer = true;
  }
  
  // Formatear distancia
  function formatDistance(meters) {
    if (meters < 1000) {
      return Math.round(meters) + ' m';
    }
    return (meters / 1000).toFixed(2) + ' km';
  }
  
  // Formatear duraciÃ³n
  function formatDuration(seconds) {
    const mins = Math.round(seconds / 60);
    if (mins < 60) {
      return mins + ' min';
    }
    const hours = Math.floor(mins / 60);
    const remainingMins = mins % 60;
    return hours + ' h ' + remainingMins + ' min';
  }
  
  // Calcular velocidad promedio aproximada segÃºn modo
  function getSpeedInfo(mode) {
    const speeds = {
      'foot': { speed: 5, unit: 'km/h', icon: 'ğŸš¶', name: 'caminando' },
      'driving': { speed: 30, unit: 'km/h', icon: 'ğŸš—', name: 'en coche' }
    };
    return speeds[mode] || speeds.foot;
  }
  
  // COMPARAR RUTAS (DEBUG)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function compareRoutes(placeId) {
    const origin = PLACES.find(p => p.id === 'oliver56');
    const destination = PLACES.find(p => p.id === placeId);
    
    if (!origin || !destination) return;
    
    console.log(`ğŸ” COMPARANDO RUTAS: ${origin.nombre} â†’ ${destination.nombre}`);
    console.log('='.repeat(70));
    console.log('ğŸŒ Usando OpenRouteService para cÃ¡lculo preciso de rutas');
    console.log('='.repeat(70));
    
    // Calcular ambas rutas en paralelo
    const [routeFoot, routeDriving] = await Promise.all([
      calculateRoute(origin.lon, origin.lat, destination.lon, destination.lat, 'foot'),
      calculateRoute(origin.lon, origin.lat, destination.lon, destination.lat, 'driving')
    ]);
    
    if (routeFoot && routeDriving) {
      console.table([
        {
          Modo: 'ğŸš¶ PEATONAL',
          Distancia: formatDistance(routeFoot.distance),
          'DuraciÃ³n': formatDuration(routeFoot.duration),
          'Puntos': routeFoot.coordinates.length,
          'Color': ROUTE_COLORS.foot,
          'Velocidad': `${(routeFoot.distance / routeFoot.duration * 3.6).toFixed(1)} km/h`
        },
        {
          Modo: 'ğŸš— VEHÃCULO',
          Distancia: formatDistance(routeDriving.distance),
          'DuraciÃ³n': formatDuration(routeDriving.duration),
          'Puntos': routeDriving.coordinates.length,
          'Color': ROUTE_COLORS.driving,
          'Velocidad': `${(routeDriving.distance / routeDriving.duration * 3.6).toFixed(1)} km/h`
        }
      ]);
      
      const diffDistance = ((routeDriving.distance - routeFoot.distance) / routeFoot.distance * 100).toFixed(1);
      const diffDuration = ((routeDriving.duration - routeFoot.duration) / routeFoot.duration * 100).toFixed(1);
      const timeSaved = routeFoot.duration - routeDriving.duration;
      
      console.log(`ğŸ“Š DIFERENCIAS:`);
      console.log(`   ğŸ“ Distancia: ${diffDistance}% (vehÃ­culo vs peatonal)`);
      console.log(`   â±ï¸ DuraciÃ³n: ${diffDuration}% (vehÃ­culo vs peatonal)`);
      if (timeSaved > 0) {
        console.log(`   âœ… Ahorro tiempo en vehÃ­culo: ${formatDuration(timeSaved)}`);
      } else {
        console.log(`   âš ï¸ VehÃ­culo tarda mÃ¡s: ${formatDuration(Math.abs(timeSaved))}`);
      }
      console.log(`   ğŸ“ Diferencia en puntos: ${routeFoot.coordinates.length - routeDriving.coordinates.length}`);
      console.log('='.repeat(70));
      
      // Verificar si las rutas son idÃ©nticas
      if (routeFoot.distance === routeDriving.distance && routeFoot.duration === routeDriving.duration) {
        console.warn('âš ï¸ LAS RUTAS SON IDÃ‰NTICAS - Posible problema con el servicio de routing');
      } else {
        console.log('âœ… Las rutas son DIFERENTES - Sistema funcionando correctamente');
      }
    } else {
      console.error('âŒ No se pudieron calcular ambas rutas para comparaciÃ³n');
    }
  }
  
  // Crear ruta desde Oliver 56 a un destino
  async function createRouteTo(map, placeId) {
    const origin = PLACES.find(p => p.id === 'oliver56');
    const destination = PLACES.find(p => p.id === placeId);
    
    if (!origin || !destination) {
      console.error('Origen o destino no encontrado');
      return;
    }
    
    const modeIcon = routeMode === 'foot' ? 'ğŸš¶' : 'ğŸš—';
    const modeText = routeMode === 'foot' ? 'a pie' : 'en vehÃ­culo';
    console.log(`ğŸ›£ï¸ Calculando ruta ${modeIcon}: ${origin.nombre} â†’ ${destination.nombre}`);
    
    // Hacer el panel transparente cuando se selecciona una ruta
    const routesContainer = document.getElementById('routes-container');
    if (routesContainer) {
      routesContainer.classList.add('transparent');
    }
    
    const route = await calculateRoute(
      origin.lon, origin.lat,
      destination.lon, destination.lat
    );
    
    if (route) {
      // Usar color segÃºn el modo de transporte
      const color = ROUTE_COLORS[route.mode] || '#ff2d55';
      animateRoute(map, route.coordinates, color);
      
      console.log(`âœ… Ruta calculada:`);
      console.log(`   Modo: ${modeText}`);
      console.log(`   Distancia: ${formatDistance(route.distance)}`);
      console.log(`   DuraciÃ³n: ${formatDuration(route.duration)} ${modeText}`);
      if (route.isPredefined) {
        console.log(`   â­ Fuente: Ruta REAL de Google Maps`);
      }
      
      // Mostrar informaciÃ³n en un toast/notificaciÃ³n
      showRouteInfo(destination.nombre, route.distance, route.duration, route.mode, route.isPredefined);
    }
  }
  
  // Mostrar informaciÃ³n de la ruta
  function showRouteInfo(destName, distance, duration, mode = 'foot', isPredefined = false) {
    const existingToast = document.getElementById('route-toast');
    if (existingToast) existingToast.remove();
    
    const modeIcon = mode === 'foot' ? 'ğŸš¶' : 'ğŸš—';
    const modeText = mode === 'foot' ? 'a pie' : 'en vehÃ­culo';
    const modeColor = ROUTE_COLORS[mode] || '#ff2d55';
    const sourceText = isPredefined ? 'ğŸ“ Google Maps' : 'ğŸŒ API';
    
    const toast = document.createElement('div');
    toast.id = 'route-toast';
    toast.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(15, 19, 32, 0.95);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      border-left: 4px solid ${modeColor};
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 10000;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    `;
    
    toast.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <strong style="font-size:14px;">${modeIcon} Ruta calculada</strong>
        <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#999;cursor:pointer;font-size:18px;">Ã—</button>
      </div>
      <div style="font-size:13px;color:#d1d5db;margin-bottom:8px;">
        <strong>Destino:</strong> ${destName}
      </div>
      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <div style="display:inline-block;padding:4px 10px;background:${modeColor};border-radius:999px;font-size:11px;">
          ${modeIcon} ${modeText.toUpperCase()}
        </div>
        ${isPredefined ? '<div style="display:inline-block;padding:4px 10px;background:#10b981;border-radius:999px;font-size:11px;">ğŸ“ RUTA REAL</div>' : ''}
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">
        <div style="background:#1e293b;padding:8px;border-radius:6px;">
          <div style="color:#94a3b8;margin-bottom:2px;">Distancia</div>
          <div style="font-weight:600;">${formatDistance(distance)}</div>
        </div>
        <div style="background:#1e293b;padding:8px;border-radius:6px;">
          <div style="color:#94a3b8;margin-bottom:2px;">DuraciÃ³n</div>
          <div style="font-weight:600;">${formatDuration(duration)}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-cerrar despuÃ©s de 8 segundos
    setTimeout(() => {
      if (toast && toast.parentElement) {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }
    }, 8000);
  }
  
  // Limpiar ruta
  function clearRoute(map) {
    if (routeAnimationId) {
      cancelAnimationFrame(routeAnimationId);
      routeAnimationId = null;
    }
    
    if (map.getLayer('route-line')) map.removeLayer('route-line');
    if (map.getLayer('route-marker')) map.removeLayer('route-marker');
    if (map.getSource('route')) map.removeSource('route');
    if (map.getSource('route-marker')) map.removeSource('route-marker');
    
    const toast = document.getElementById('route-toast');
    if (toast) toast.remove();
    
    // Restaurar la visibilidad normal del panel de rutas
    const routesContainer = document.getElementById('routes-container');
    if (routesContainer) {
      routesContainer.classList.remove('transparent');
    }
    
    currentRouteLayer = null;
    console.log('ğŸ§¹ Ruta eliminada');
  }

  // Insights / anÃ¡lisis estructurados
  const INSIGHTS = [
    {
      id: "planeamiento",
      titulo: "Planeamiento (PGOU Alcoi) â€” sÃ­ntesis operativa",
      etiquetas: ["PGOU", "Usos", "C-1/C-3"],
      contenido: [
        "Uso vivienda permitido en edificaciÃ³n cerrada. Programa mÃ­nimo compatible con tipologÃ­as ~45 mÂ² (estar-comedor, cocina, 1 dormitorio y aseo).",
        "Terciarioâ€“comercial admitido en planta baja. Alternativa: alojamiento con servicios (turÃ­stico-residencial) sujeto a condiciones.",
        "DotaciÃ³n de aparcamiento obligatoria conforme estÃ¡ndares municipales (dimensionar sÃ³tanos/ramps).",
        "Verificar ordenanza exacta y 'situaciÃ³n/grado' de la manzana para C/ Oliver 56 (C-1/C-3).",
        "Marco general vigente del PGOU (Texto Refundido):",
        "1. - Usos y ordenanzas relevantes:",
        "TÃ­tulo 6 â€“ Normativa de usos:",
        "Cap. 2 â€“ Uso vivienda: se permite como uso caracterÃ­stico en edificaciÃ³n cerrada. Programa mÃ­nimo: cocina, estar-comedor, 1 dormitorio doble o 2 sencillos + aseo; dormitorios de 10 mÂ² (doble) o 6 mÂ² (simple) mÃ­n.; alturas mÃ­n. 2,50 m en â‰¥75 % de la S. Ãºtil. ",
        "Cap. 5 â€“ Uso terciario (oficinas/comercial/recreativo/turÃ­stico-residencial). El turÃ­stico-residencial comprende alojamiento temporal (hostelerÃ­a/apartamentos), Ãºtil si se formaliza como residencia con servicios. ",
        "TÃ­tulo 7 â€“ Normas particulares en suelo urbano â€“ EdificaciÃ³n cerrada (C-1/C-3):",
        "Zona C-1 (manzana densa): admite Residencia en determinadas situaciones/grados y comercial en planta baja (condicionado a â€œsituaciones B/Câ€). C-3 (barrios perifÃ©ricos) similar para vivienda y terciario compatible. (Ver artÃ­culos especÃ­ficos de cada zona).",
        "Lectura para proyecto:",
        "Viviendas de 45 mÂ²:",
        "Encajan en Uso vivienda por programa y dimensiones mÃ­nimas.",
        "Si se desea operar como â€œresidencia de estudiantes con serviciosâ€, cabe canalizarlo:",
        "Como vivienda (coliving/estudios) con estatuto de residencial y servicios comunes en elementos comunes.",
        "Como â€œturÃ­stico-residencialâ€/colectivo con servicios si la ordenanza lo admite en el edificio (consultar â€œsituacionesâ€ y â€œgradosâ€ de C-1/C-3 y, en su caso, LOâ€“TUP autonÃ³mica).",
        "En ambos casos, licencia y justificaciÃ³n de uso deberÃ¡n alinearse con ordenanza y compatibilidades. ",
        "2. - Planta baja comercial (toda la parcela):",
        "El uso terciario-comercial en planta baja es tÃ­picamente compatible en C-1/C-3; viable para â€œoffice de supermercado/charterâ€, tienda de conveniencia o servicios (cafeterÃ­a/estudio copy/paqueterÃ­a). Ajustar a retranqueos, salidas de humos (si aplica), carga/descarga (Art. 303 ss.), y ruidos. ",
        "3. - Aparcamiento y estÃ¡ndares:",
        "DotaciÃ³n de aparcamiento obligatoria en el interior de edificio/parcela (â‰¥40 % cubiertas), con excepciones por geometrÃ­a. El ratio exacto depende del uso y se calcula por el art. 277 y tablas aplicables. Recomiendo estudio especÃ­fico para dimensionar sÃ³tanos. ",
        "4. - Condiciones bÃ¡sicas de habitabilidad:",
        "Alturas mÃ­nimas (2,50 m Ãºtil >75 %), dimensiones de huecos, ventilaciÃ³n e iluminaciÃ³n natural (proporciones 1:8), anchuras de escaleras/puertas y accesibilidad. Estas condiciones encajan con micro-apartamentos de ~45 mÂ² bien resueltos."
      ],
      nota: "Requiere confirmaciÃ³n en plano de zonificaciÃ³n + ficha urbanÃ­stica municipal."
    },
    {
      id: "magnitud",
      titulo: "Demanda â€œstudent livingâ€ en Alcoy",
      etiquetas: ["UbicaciÃ³n", "Demanda", "Magnitud"],
      contenido: [
        "1. - UbicaciÃ³n prime â€œservicios+campus",
        "A ~10â€“15 min a pie del Campus dâ€™Alcoi (UPV), y a <10 min del Centro Comercial Alzamora (ocio, restauraciÃ³n, cines), con el Hospital IMED San Jorge justo enfrente (C/ Oliver, 55). Excelente para producto â€œstudent living con serviciosâ€ y retail de conveniencia.",
        "2. - Demanda creciente:",
        "El campus reporta ~2.7â€“2.9k estudiantes totales y ~900 nuevos de ingreso/aÃ±o; la UPV-Alcoi ha cubierto 879 plazas con 1.196 en lista de espera y prevÃ© crecer (horizonte 4.2k en 2031). Oferta formal actual: 1 colegio mayor relevante (~85 habs) + pisos compartidos; hueco para micro-apartamentos con servicios.",
        "3. - Planeamiento:",
        "El PGOU de Alcoi permite uso vivienda en edificaciÃ³n cerrada (ordenanzas C-1/C-3 de casco/barrio perifÃ©rico), terciario-comercial en planta baja, y turÃ­stico-residencial (alojamiento) bajo condiciones; el programa mÃ­nimo de vivienda y dimensiones de piezas hacen viable tipologÃ­as de 45 mÂ². Aparcamiento obligatorio segÃºn estÃ¡ndares del TÃ­tulo 6. ",
        "4. - Magnitud del activo:",
        "DocumentaciÃ³n comercial del inmueble cita parcela ~1.580 mÂ² y edificabilidad potencial ~9.960 mÂ² (obra paralizada), que encaja con un esquema de 2 bloques + bajo comercial. (Sujeto a verificaciÃ³n tÃ©cnica del planeamiento/expedientes).",
        "5.- TamaÃ±o del mercado (2025):",
        "UPV-Alcoi â‰ˆ 2.7â€“2.9 k estudiantes (â‰ˆ900 de nuevo ingreso/aÃ±o).",
        "En 2025 la ciudad supera 3.000 universitarios sumando UPV, UA y EASD. Plan de crecimiento del campus (objetivo 4.2 k a 2031).",
        "6.- Capacidad formal existente:",
        "Colegio Mayor Ovidi Montllor (~85 habitaciones); precios residencias en Alcoy: 650â€“750 â‚¬/mes (normalmente con media pensiÃ³n/pensiÃ³n completa). Habitaciones en pisos compartidos: ~200â€“300 â‚¬/mes. Resultado: brecha de producto intermedio (estudio con cocina propia + servicios).",
        "7.- Momentum:",
        "Alta demanda de plazas de grado (preinscripciÃ³n completamente cubierta y lista de espera amplia). Buena tracciÃ³n anual de entrantes. ",
      ],
      nota: "Datos procedentes de documentaciÃ³n comercial; verificar en expediente."
    },
    {
      id: "demanda",
      titulo: "Servicios Universitarios y locales",
      etiquetas: ["UPV-Alcoi", "Ocio", "Servicios"],
      contenido: [
        "1. - Universidad y equipamientos",
        "Campus dâ€™Alcoi (UPV): sede en PlaÃ§a FerrÃ¡ndiz i Carbonell s/n; ademÃ¡s del Edificio Georgina Blanes (gimnasio, pabellÃ³n, pistas, parking). Distancia estimada C/ Oliver 56 â†’ FerrÃ¡ndiz/Carbonell: ~1.0â€“1.3 km (10â€“15 min a pie).",
        "2. - Teatre CalderÃ³n (Pl. dâ€™Espanya, 14):", 
        "Menos de 12â€“18 min a pie desde Oliver 56; foco cultural.",
        "3. - Hospital IMED San Jorge (C/ Oliver, 55):", 
        "Cercano al solar; urgencias 24 h, hospitalizaciÃ³n, diagnÃ³stico, fisio/reha. Valor para conveniencia y seguridad percibida del estudiantado.",
        "4. - Compra diaria y restauraciÃ³n/ocio",
        "Centro Comercial Alzamora (C/ Els AlÃ§amora, 44): retail, restauraciÃ³n y cines (Cine BIC / Axion, 8 salas). Distancia: ~400â€“700 m (5â€“9 min a pie) segÃºn trimo de Oliver.",
        "5. - Supermercados cercanos:", 
        "Mercadona C/ Santa Rosa, 7; Consum Paseo de la Alameda / Tirant lo Blanc s/n; Lidl C/ Valencia, 2 (todos a pocos min en coche o 10â€“18 min a pie segÃºn punto). ",
        "6. - Gimnasios:",
        "SR Sport & Training en C/ Oliver, 52 (literalmente a unos pasos); Sparta Alzamora (en el propio CC Alzamora). ",
        "7. - RestauraciÃ³n prÃ³xima (muestra):",
        "Cosa Nostra / Fosterâ€™s (Alzamora), Bar Deportivo (Oliver, 36), oferta variada centro-Alcoy. ",
        "8. - Parques y puntos de interÃ©s:", 
        "La Glorieta (Pl. RamÃ³n i Cajal) y Passeig de Cervantes a ~12â€“18 min a pie."
      ],
      nota: "Ajustar con series oficiales de matrÃ­cula y ofertas de alojamiento."
    },
    {
      id: "capacidad",
      titulo: "Programa recomendado (concept design):",
      etiquetas: ["Unidades", "SNU", "Rendimiento"],
      contenido: [
        "1.- Objetivo:",
        "2 Edificios residenciales con mix 70â€“80 % estudios de 1 dorm (~45 mÂ²) + 20â€“30 % 1-bed superior (50â€“55 mÂ²) para flexibilidad, y bajo comercial 100 % parcela (o 1â€“2 locales modulables, p. ej. charter de supermercado + lavanderÃ­a/cafeterÃ­a).",
        "2.- Amenidades â€œstudent livingâ€:",
        "Study rooms por plantas, cowork bÃ¡sico, taller prototipado ligero (si cuadra con UPV), gym ligero (o acuerdo con SR Sport & Training), laundry autoservicio, taquillas paqueterÃ­a. (ConexiÃ³n natural con Alzamora y IMED como anclas de servicios). ",
        "3.- Capacidad orientativa (sujeta a planeamiento y proyecto):",
        "Edificabilidad ~9.960 mÂ² y se destina ~80 % a residencial (resto a zonas comunes/amenities) â‡’ 7.500â€“8.000 mÂ² netos para unidades. Con 45 mÂ²/vivienda â‡’ ~165â€“175 unidades (+ unidades mayores y adaptadas). (Ajustando por nÃºcleos, patios, circulaciones y cumplimiento de Art. 280â€“287).",
        "4.- Residencias:", 
        "650â€“750 â‚¬/mes con media pensiÃ³n o PC; 85 habitaciones (Ovidi).",
        "Pisos compartidos: 200â€“300 â‚¬/mes/hab.",
        "Un estudio privado nuevo (45 mÂ²) con servicios podrÃ­a posicionarse intermedio-alto (benchmark local + valor aÃ±adido), buscando ocupaciÃ³n 10â€“11 meses con campaÃ±as (septâ€“jul), reservas por lista de espera del campus."
      ],
      nota: "Valores guÃ­a; recalcular con mediciones y ordenanza exacta."
    }
  ];

  // ============================================================================
  // FUNCIONES PARA MANEJO DE MARCADORES Y POPUPS
  // ============================================================================
  
  // Almacenamiento global para marcadores
  let mapMarkers = [];
  
  // Registrar un marcador en la colecciÃ³n global
  function registerMarker(marker, placeId) {
    mapMarkers.push({
      marker: marker,
      placeId: placeId
    });
  }
  
  // Encontrar un marcador por su placeId
  function findMarkerByPlaceId(placeId) {
    const found = mapMarkers.find(item => item.placeId === placeId);
    return found ? found.marker : null;
  }
  
  // Cerrar todos los popups abiertos
  function closeAllPopups() {
    // Cerrar solo el popup actualmente abierto, si existe
    if (window.currentOpenMarker) {
      try {
        if (window.currentOpenMarker.getPopup() && window.currentOpenMarker.getPopup().isOpen()) {
          window.currentOpenMarker.togglePopup(); // Cerrar el popup actual
        }
      } catch (e) {
        console.warn('Error al cerrar popup:', e);
      }
      window.currentOpenMarker = null;
    }
  }
  
  // ============================================================================
  // FUNCIONES AUXILIARES PARA DISTANCIAS
  // ============================================================================
  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Radio de la Tierra en metros
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2) ** 2 + 
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
              Math.sin(dLon/2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // metros
  }
  
  function formatMeters(m) {
    if (m < 1000) return `${Math.round(m)} m`;
    return `${(m / 1000).toFixed(2)} km`;
  }
  
  function walkingMinutes(meters) {
    const mps = 1.33; // ~4.8 km/h velocidad de caminata promedio
    const mins = meters / mps / 60;
    return Math.round(mins);
  }

  // ---- FunciÃ³n para generar coordenadas con variaciÃ³n ----
  function addRandomOffset(coords, radiusKm = 2) {
    // AÃ±ade una variaciÃ³n aleatoria dentro de un radio especÃ­fico
    const earthRadius = 6371; // Radio de la Tierra en km
    const randomDistance = Math.random() * radiusKm;
    const randomAngle = Math.random() * 2 * Math.PI;
    
    const deltaLat = (randomDistance / earthRadius) * (180 / Math.PI);
    const deltaLng = (randomDistance / earthRadius) * (180 / Math.PI) / Math.cos(coords.lat * Math.PI / 180);
    
    return {
      lat: coords.lat + deltaLat * Math.cos(randomAngle),
      lng: coords.lng + deltaLng * Math.sin(randomAngle)
    };
  }

  // ---- FunciÃ³n para procesar imÃ¡genes automÃ¡ticamente ----
  function parseImageFileName(fileName) {
    // Formato esperado: IDENTIFICADOR - TIPO - LOCALIDAD - PROVINCIA.jpg
    // Ejemplo: DELTA - 001 - SUELO URBANO - MADRID - MADRID.jpg
    const nameWithoutExt = fileName.replace('.jpg', '').replace('.JPG', '');
    const parts = nameWithoutExt.split(' - ');
    
    if (parts.length >= 4) {
      const identificador = parts.slice(0, 2).join(' - '); // DELTA - 001
      const tipo = parts[2]; // SUELO URBANO
      const localidad = parts[3]; // MADRID
      let provincia = parts[4] || parts[3]; // MADRID (o usa localidad si no hay provincia)
      
      // Normalizar nombres de provincia para que coincidan con colorByDominio
      const provinciaMap = {
        'MADRID': 'Madrid',
        'VALENCIA': 'Valencia', 
        'ALICANTE': 'Alicante',
        'BARCELONA': 'Barcelona',
        'SEVILLA': 'Sevilla',
        'TOLEDO': 'Toledo',
        'MURCIA': 'Murcia',
        'CADIZ': 'Cadiz',
        'ALMERIA': 'Almeria',
        'SALAMANCA': 'Salamanca',
        'CACERES': 'Caceres',
        'ZARAGOZA': 'Zaragoza',
        'CANTABRIA': 'Cantabria',
        'LAS PALMAS': 'Las Palmas',
        'GIRONA': 'Girona',
        'GUADALAJARA': 'Guadalajara',
        'MALAGA': 'Malaga',
        'CIUDAD REAL': 'Ciudad Real',
        'TARRAGONA': 'Tarragona'
      };
      provincia = provinciaMap[provincia.toUpperCase()] || provincia;
      
      // Obtener coordenadas especÃ­ficas por localidad, si no existe usar provincia
      const baseCoords = coordenadasPorLocalidad[localidad.toUpperCase()] || 
                         coordenadasPorProvincia[provincia] || 
                         { lat: 40.4168, lng: -3.7038 };
      
      // AÃ±adir variaciÃ³n aleatoria para ubicaciones mÃ¡s precisas
      const coords = addRandomOffset(baseCoords, 1.5); // Radio de 1.5km
      
      // Normalizar tipos para que coincidan con los chips
      const tipoMap = {
        'SUELO TERCIARIO': 'Suelo Terciario',
        'SUELO URBANIZABLE': 'Suelo Urbanizable', 
        'SUELO URBANO': 'Suelo Urbano',
        'SUELO RUSTICO': 'Suelo Rustico',
        'WIP': 'WIP',
        'LOCAL COMERCIAL': 'Local Comercial',
        'EDIFICIO': 'Edificio',
        'PLAZAS DE GARAJE': 'Plazas de Garaje',
        'HOTEL': 'Hotel',
        'COMPLEJO TERCIARIO': 'Complejo Terciario'
      };
      const tipoNormalizado = tipoMap[tipo.toUpperCase()] || tipo;

      return {
        id: identificador,
        nombre: '', // VacÃ­o como solicitado
        descripcion: tipo,
        dominio: provincia, // Provincia para chips de ubicaciÃ³n
        categoria: tipoNormalizado, // Tipo normalizado para filtros
        precio: 'Medio', // Precio por defecto
        lat: coords.lat, // Coordenadas con variaciÃ³n
        lng: coords.lng,
        imagen: './' + fileName,
        referenciasCatastrales: '' // Campo para referencias catastrales
      };
    }
    return null;
  }

  // Lista de imÃ¡genes a procesar automÃ¡ticamente
  // INSTRUCCIONES DE USO:
  // 1. Coloca tus archivos .jpg en la raÃ­z del proyecto
  // 2. Nombra los archivos siguiendo el formato: IDENTIFICADOR - TIPO - LOCALIDAD - PROVINCIA.jpg
  // 3. AÃ±ade los nombres de archivo a este array
  // 4. El sistema procesarÃ¡ automÃ¡ticamente cada imagen y crearÃ¡ las fichas
  
  const imagenesDisponibles = [
    // Fichas inmobiliarias organizadas en carpeta /fichas
    
  ];

  // Procesar imÃ¡genes automÃ¡ticamente
  const dataFromImages = imagenesDisponibles
    .map(parseImageFileName)
    .filter(item => item !== null);

  // Usar solo los datos procesados automÃ¡ticamente desde las imÃ¡genes reales
  const data = dataFromImages;

  const PRECIOS = ['Bajo','Medio','Alto','Premium'];
  const TIPOS = ['Suelo Terciario','Suelo Urbanizable','Suelo Urbano','Suelo Rustico','WIP','Local Comercial','Edificio','Plazas de Garaje','Hotel','Complejo Terciario'];

  // Colores Ãºnicos por provincia para el mapa
  const colorByDominio = {
    'Madrid': '#8b5cf6',        // Violeta
    'Valencia': '#06b6d4',      // Cian
    'Alicante': '#10b981',      // Esmeralda
    'Barcelona': '#f59e0b',     // Ãmbar
    'Sevilla': '#ef4444',       // Rojo
    'Toledo': '#a855f7',        // PÃºrpura
    'Murcia': '#f97316',        // Naranja
    'Cadiz': '#3b82f6',         // Azul
    'Almeria': '#eab308',       // Amarillo
    'Salamanca': '#ec4899',     // Rosa
    'Caceres': '#84cc16',       // Lima
    'Zaragoza': '#6366f1',      // Ãndigo
    'Cantabria': '#14b8a6',     // Teal
    'Las Palmas': '#f43f5e',    // Rosa intenso
    'Girona': '#8b5cf6',        // Violeta claro
    'Guadalajara': '#22c55e',   // Verde
    'Malaga': '#fb7185',        // Rosa coral
    'Ciudad Real': '#facc15',   // Amarillo dorado
    'Tarragona': '#a3a3a3'      // Gris
  };

  // ConstrucciÃ³n dinÃ¡mica de chips & selects de dominio
  const DOMINIOS = Array.from(new Set([
    'Madrid','Valencia','Alicante','Barcelona','Sevilla','Toledo','Murcia',
    'Cadiz','Almeria','Salamanca','Caceres','Zaragoza','Cantabria','Las Palmas',
    'Girona','Guadalajara','Malaga','Ciudad Real','Tarragona',
    ...data.map(d=>d.dominio)
  ]));

  // ---- Estado UI ----
  const state = {
    texto: '',
    dominio: '',
    precio: '',
    tipo: '',
    chips: { dominio: new Set(), precio: new Set(), tipo: new Set() },
    view:'map'
  };

  // ---- Utilidades ----
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function createChip(text, group){
    const el = document.createElement('span');
    el.className = 'chip';
    el.textContent = text;
    el.dataset.active = 'false';
    el.addEventListener('click', () => {
      const active = el.dataset.active === 'true';
      el.dataset.active = (!active).toString();
      if(!active) state.chips[group].add(text); else state.chips[group].delete(text);
      render();
    });
    return el;
  }

  function createChipWithSync(text, group, isFullscreen = false){
    const el = document.createElement('span');
    el.className = 'chip';
    el.textContent = text;
    el.dataset.active = 'false';
    el.addEventListener('click', () => {
      const active = el.dataset.active === 'true';
      el.dataset.active = (!active).toString();
      if(!active) state.chips[group].add(text); else state.chips[group].delete(text);
      
      // Sincronizar con el chip correspondiente en la otra vista
      if (isFullscreen) {
        // Sincronizar desde fullscreen a normal
        const normalChips = $$(`#chips-${group} .chip`);
        const normalChip = normalChips.find(chip => chip.textContent === text);
        if (normalChip) normalChip.dataset.active = el.dataset.active;
      } else {
        // Sincronizar desde normal a fullscreen
        const fullscreenChips = $$(`#chips-${group}-fullscreen .chip`);
        const fullscreenChip = fullscreenChips.find(chip => chip.textContent === text);
        if (fullscreenChip) fullscreenChip.dataset.active = el.dataset.active;
      }
      
      render();
    });
    return el;
  }

  function setupChips(){
    // Ya no usamos chips, usamos desplegables
    // Renderizar lista de lugares por categorÃ­a
    renderPlacesByCategory();
  }
  
  function renderPlacesByCategory() {
    // Mapeo de categorÃ­as a IDs de contenedores
    const categoryMapping = {
      'Objetivo': 'objetivo',
      'Universidad': 'universidad',
      'Salud': 'salud',
      'Comercio': 'comercio',
      'Servicios': 'servicios',
      'Transporte': 'transporte',
      'Cultura/Parque': 'cultura'
    };
    
    Object.entries(categoryMapping).forEach(([category, containerId]) => {
      const places = PLACES.filter(p => p.categoria === category);
      const container = document.getElementById(`cat-${containerId}`);
      
      if (!container) {
        console.warn(`No se encontrÃ³ el contenedor para la categorÃ­a: ${category}, ID: cat-${containerId}`);
        return;
      }
      
      console.log(`Poblando categorÃ­a: ${category}, ID: cat-${containerId}, Elementos: ${places.length}`);
      
      container.innerHTML = places.map(place => {
        const color = CAT_COLORS[category] || '#999';
        
        return `
          <div 
            class="place-item"
            data-place-id="${place.id}"
            style="
              padding:8px 10px;
              margin-bottom:6px;
              background:var(--chip);
              border:1px solid var(--grid);
              border-radius:8px;
              cursor:pointer;
              font-size:12px;
              transition:all 0.2s;
              display:flex;
              align-items:center;
              gap:6px;
            "
            onmouseover="this.style.background='var(--panel)';this.style.borderColor='${color}'"
            onmouseout="this.style.background='var(--chip)';this.style.borderColor='var(--grid)'"
          >
            <span style="color:${color};font-size:10px;">â—</span>
            <span style="flex:1;">${place.nombre}</span>
          </div>
        `;
      }).join('');
    });
    
    console.log('âœ… Desplegables del sidebar principal poblados');
  }


  function syncFilters() {
    // Sincronizar filtros entre vista normal y pantalla completa
    // Ya no se usan los chips antiguos (precios, tipos, dominio)
    // Solo sincronizar el campo de bÃºsqueda
    const qField = $('#q');
    const qFullscreen = $('#q-fullscreen');
    if (qField && qFullscreen) {
      qFullscreen.value = qField.value;
    }
  }

  function passFilters(item){
    const t = (state.texto||'').toLowerCase();
    if(t){
      const hay = (item.nombre + ' ' + item.descripcion + ' ' + item.dominio + ' ' + item.categoria).toLowerCase();
      if(!hay.includes(t)) return false;
    }
    if(state.dominio && item.dominio !== state.dominio) return false;
    if(state.precio && item.precio !== state.precio) return false;
    if(state.tipo && item.categoria !== state.tipo) return false;
    if(state.chips.precio.size && !state.chips.precio.has(item.precio)) return false;
    
    if(state.chips.tipo.size && !state.chips.tipo.has(item.categoria)) return false;
    
    if(state.chips.dominio.size && !state.chips.dominio.has(item.dominio)) return false;
    return true;
  }

  function card(item){
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <img class="thumb" src="${item.imagen}" alt="${item.nombre}"/>
      <h3>${item.nombre}</h3>
      <div class="meta">
        <span class="badge">${item.dominio}</span>
        <span class="badge">${item.categoria}</span>
        <span class="badge">Precio: ${item.precio}</span>
      </div>
      <p style="margin:0;color:#d7dbea">${item.descripcion||''}</p>
      <div class="actions">
        <button class="primary">Ampliar</button>
        <a class="button" href="${item.imagen}" download>Descargar</a>
      </div>
    `;
    el.querySelector('.primary').addEventListener('click', ()=>openModal(item));
    return el;
  }

  function renderGrid(){
    const container = $('#grid');
    container.innerHTML = '';
    
    // Renderizar insights en lugar de las fichas antiguas
    INSIGHTS.forEach(insight => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.gridColumn = 'span 6';
      
      // FunciÃ³n para detectar el nivel de jerarquÃ­a y aplicar estilos
      const formatContent = (items) => {
        return items.map(c => {
          // Nivel 1: Marco general (tÃ­tulos principales)
          if (c.startsWith('Marco general') || c.match(/^[A-Z][^:]*:\s*$/)) {
            return `<li style="margin:16px 0 8px 0;font-size:15px;font-weight:700;color:var(--accent);list-style:none;margin-left:-20px;">${c}</li>`;
          }
          // Nivel 2: Secciones numeradas (1., 2., 3., ...)
          else if (c.match(/^\d+\.\s*-/)) {
            return `<li style="margin:14px 0 8px 0;font-size:14.5px;font-weight:700;color:#fbbf24;list-style:none;margin-left:-15px;padding-left:15px;border-left:4px solid #fbbf24;">${c}</li>`;
          }
          // Nivel 3: TÃ­tulos secundarios (TÃ­tulo X)
          else if (c.match(/^TÃ­tulo \d+/)) {
            return `<li style="margin:12px 0 6px 0;font-size:14px;font-weight:600;color:#93c5fd;list-style:none;margin-left:-10px;padding-left:10px;border-left:3px solid var(--accent2);">${c}</li>`;
          }
          // Nivel 4: CapÃ­tulos (Cap. X)
          else if (c.startsWith('Cap. ')) {
            return `<li style="margin:8px 0 4px 0;font-size:13px;font-weight:500;color:#a5b4fc;">${c}</li>`;
          }
          // Nivel 5: Zonas especÃ­ficas
          else if (c.match(/^Zona [A-Z0-9-]+:/)) {
            return `<li style="margin:8px 0 4px 0;font-size:13px;font-weight:500;color:#34d399;">${c}</li>`;
          }
          // Contenido normal
          else {
            return `<li style="margin-bottom:8px;">${c}</li>`;
          }
        }).join('');
      };
      
      card.innerHTML = `
        <h3 style="font-size:18px;margin-bottom:10px;color:var(--accent)">${insight.titulo}</h3>
        <div class="badges" style="margin-bottom:12px">
          ${insight.etiquetas.map(t => `<span class="badge">${t}</span>`).join('')}
        </div>
        <ul style="margin:0;padding-left:20px;color:var(--text);line-height:1.7;font-size:13px;">
          ${formatContent(insight.contenido)}
        </ul>
        ${insight.nota ? `<p style="margin-top:12px;padding:10px;background:var(--chip);border-radius:8px;border:1px solid var(--grid);color:var(--muted);font-size:12px;"><strong>Nota:</strong> ${insight.nota}</p>` : ''}
      `;
      container.appendChild(card);
    });
  }

  function openModal(item){
    $('#m-title').textContent = item.nombre;
    $('#m-img').src = item.imagen;
    $('#m-img').alt = item.nombre;
    $('#m-desc').textContent = item.descripcion || '';
    const meta = $('#m-meta'); meta.innerHTML='';
    [item.dominio, item.categoria, 'Precio: '+item.precio].forEach(d => {
      const b = document.createElement('span'); b.className='badge'; b.textContent=d; meta.appendChild(b);
    });
    const dl = $('#btn-download'); dl.href = item.imagen; dl.setAttribute('download', (item.id||'imagen')+'.jpg');
    modal.showModal();
  }

  // ============================================================================
  // CONFIGURACIÃ“N DE ESTILOS MAPLIBRE
  // ============================================================================
  const MAP_STYLES = {
    'grayscale': 'https://tiles.openfreemap.org/styles/positron',
    'topographic': 'https://tiles.openfreemap.org/styles/bright',
    'satellite': {
      version: 8,
      name: 'Satellite',
      sources: {
        'esri-satellite': {
          type: 'raster',
          tiles: [
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          ],
          tileSize: 256,
          attribution: 'Â© Esri, Maxar, Earthstar Geographics'
        },
        'openmaptiles': {
          type: 'vector',
          url: 'https://demotiles.maplibre.org/tiles/tiles.json'
        }
      },
      layers: [
        {
          id: 'satellite-tiles',
          type: 'raster',
          source: 'esri-satellite',
          minzoom: 0,
          maxzoom: 22
        }
      ]
    }
  };

  // ============================================================================
  // MAPA MAPLIBRE
  // ============================================================================
  let map;
  let is3DEnabled = false;
  let dxfData = null; // Datos del archivo DXF (si se carga)
  let buildingsCanvas = null; // Canvas para edificios 3D desde DXF
  let currentTileLayer = null; // Capa de tiles actual
  const parcelaLat = 38.69248236972135;
  const parcelaLng = -0.4884948327116618;

  // Variable global para el mapa
  let mapInitialized = false;
  
  function ensureMap() {
    if (mapInitialized) return map;
    
    console.log('Inicializando mapa...');
    mapInitialized = true;
    
    // Inicializar mapa MapLibre con Positron por defecto (mejor para edificios 3D)
    map = new maplibregl.Map({
      container: 'map',
      style: MAP_STYLES['grayscale'], // Positron
      center: [parcelaLng, parcelaLat],
      zoom: 17, // Zoom 17 para ver edificios 3D
      pitch: 0,
      bearing: 0,
      antialias: true,
      maxPitch: 85
    });

    // AÃ±adir controles de navegaciÃ³n
    map.addControl(new maplibregl.NavigationControl(), 'top-left');
    map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
    map.addControl(new maplibregl.FullscreenControl(), 'top-left');

    // AÃ±adir marcador de la parcela cuando el mapa estÃ© cargado
    map.on('load', () => {
      console.log('ğŸ—ºï¸ Mapa cargado');
      
      // Inicializar eventos del sidebar despuÃ©s de que el mapa estÃ© completamente cargado
      setTimeout(initSidebarEvents, 500);
      console.log('âœ… Mapa MapLibre cargado correctamente');
      console.log('ğŸ“ Centro:', map.getCenter());
      console.log('ğŸ” Zoom actual:', map.getZoom());
      console.log('ğŸ—ï¸ Fuentes disponibles:', Object.keys(map.getStyle().sources || {}));
      
      // Crear elemento para el marcador de la parcela objetivo
      const el = document.createElement('div');
      el.style.width = '22px';
      el.style.height = '22px';
      el.innerHTML = `<div style="background:${CAT_COLORS["Objetivo"]};width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.5)"></div>`;
      
      // AÃ±adir marcador de la parcela objetivo
      new maplibregl.Marker(el)
        .setLngLat([parcelaLng, parcelaLat])
        .setPopup(new maplibregl.Popup({
          offset: 15,
          closeButton: true,
          maxWidth: '380px'
        }).setHTML(`
          <div class="popup-content">
            <h3>ğŸ¯ Edificio Oliver 56</h3>
            <div class="addr">Calle Oliver 56, Alcoy (Alicante)</div>
            <div class="popup-chips">
              <span class="popup-chip">Objetivo</span>
              <span class="popup-chip">Residencial</span>
            </div>
            <p>Edificio de viviendas en zona cÃ©ntrica de Alcoy. Uso residencial compatible con comercial.</p>
            <div class="coords-box">
              <span>ğŸ“</span>
              <span>${parcelaLat.toFixed(6)}, ${parcelaLng.toFixed(6)}</span>
            </div>
            <div style="margin-top:8px;padding:8px;background:#0b0f19;border:1px solid var(--border);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Referencia Catastral</div>
              <div style="font-size:14px;font-family:monospace;color:var(--text);">8658801YH1885N0123PF</div>
            </div>
          </div>
        `))
        .addTo(map);
      
      // AÃ±adir marcadores de emplazamientos con estilo mejorado
      console.log('ğŸ“ Agregando', PLACES.length, 'marcadores al mapa');
      PLACES.forEach((place, index) => {
        if (!place.lat || !place.lon) return;
        
        const color = CAT_COLORS[place.categoria] || '#93c5fd';
        const markerEl = document.createElement('div');
        markerEl.style.cursor = 'pointer';
        markerEl.style.width = '20px';
        markerEl.style.height = '20px';
        markerEl.innerHTML = `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 3px 12px rgba(0,0,0,0.5);cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></div>`;
        
        // Calcular distancias
        const campus = PLACES.find(p => p.id === 'upv-campus');
        const alzamora = PLACES.find(p => p.id === 'alzamora');
        
        let distCampus = 'N/A';
        let distAlzamora = 'N/A';
        
        if (campus?.lat && campus?.lon && place.id !== 'upv-campus') {
          const d = haversine(place.lat, place.lon, campus.lat, campus.lon);
          distCampus = `${formatMeters(d)} (~${walkingMinutes(d)} min a pie)`;
        }
        
        if (alzamora?.lat && alzamora?.lon && place.id !== 'alzamora') {
          const d = haversine(place.lat, place.lon, alzamora.lat, alzamora.lon);
          distAlzamora = `${formatMeters(d)} (~${walkingMinutes(d)} min a pie)`;
        }
        
        const popupHTML = `
          <div class="popup-content">
            <h3>${place.nombre}</h3>
            <div class="addr">${place.direccion || ''}</div>
            <div class="popup-chips">
              ${(place.etiquetas || []).map(t => `<span class="popup-chip">${t}</span>`).join('')}
            </div>
            <p>${place.resumen || ''}</p>
            <div class="coords-box">
              <span>ğŸ“</span>
              <span>${place.lat.toFixed(6)}, ${place.lon.toFixed(6)}</span>
            </div>
            ${place.id !== 'upv-campus' && place.id !== 'alzamora' ? `
            <div class="metrics-grid">
              <div class="metric-box">
                <b>â†’ Campus UPV</b>
                <small>${distCampus}</small>
              </div>
              <div class="metric-box">
                <b>â†’ CC Alzamora</b>
                <small>${distAlzamora}</small>
              </div>
            </div>
            ` : ''}
            ${place.nota ? `<div class="note-box"><strong>Nota:</strong> ${place.nota}</div>` : ''}
          </div>
        `;
        
        console.log(`âœ… Marcador ${index + 1}/${PLACES.length}: ${place.nombre}`);
        
        const marker = new maplibregl.Marker(markerEl)
          .setLngLat([place.lon, place.lat])
          .setPopup(new maplibregl.Popup({ 
            offset: 15,
            closeButton: true,
            closeOnClick: true,
            maxWidth: '380px'
          }).setHTML(popupHTML))
          .addTo(map);
          
        // Registrar el marcador en la colecciÃ³n global
        registerMarker(marker, place.id);
          
        marker.getElement().addEventListener('click', () => {
          console.log('ğŸ‘† Click en marcador:', place.nombre);
          
          // Cerrar cualquier otro popup abierto
          if (window.currentOpenMarker && window.currentOpenMarker !== marker) {
            window.currentOpenMarker.togglePopup();
          }
          
          // Actualizar la referencia al marcador actual
          window.currentOpenMarker = marker;
        });
      });
      
      console.log('âœ… Todos los marcadores agregados exitosamente');
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // POPULAR DESPLEGABLES DE RUTAS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const categoryMapping = {
        'Universidad': 'universidad',
        'Salud': 'salud',
        'Comercio': 'comercio',
        'Transporte': 'transporte',
        'Cultura/Parque': 'cultura'
      };
      
      Object.entries(categoryMapping).forEach(([category, containerId]) => {
        const places = getPlacesByCategory(category);
        const container = document.getElementById(`routes-${containerId}`);
        
        if (!container || places.length === 0) return;
        
        container.innerHTML = places.map(place => {
          const color = CAT_COLORS[category] || '#999';
          return `
            <button 
              onclick="createRouteTo(map, '${place.id}')" 
              class="route-button"
              data-color="${color}"
            >
              <span class="route-dot" style="background:${color};"></span>
              <span class="route-name">${place.nombre}</span>
              <span class="route-arrow">â†’</span>
            </button>
          `;
        }).join('');
      });
      
      console.log('ğŸ›£ï¸ Desplegables de rutas poblados');
      
      // AÃ±adir eventos de hover a los botones de ruta
      document.querySelectorAll('.route-button').forEach(button => {
        const color = button.getAttribute('data-color');
        
        button.addEventListener('mouseover', () => {
          button.style.borderColor = color;
        });
        
        button.addEventListener('mouseout', () => {
          button.style.borderColor = 'var(--grid)';
        });
      });
    });

    map.on('styledata', () => {
      console.log('ğŸ¨ Estilo cargado');
      console.log('ğŸ—ï¸ Fuentes del estilo:', Object.keys(map.getStyle().sources || {}));
    });

    map.on('error', (e) => {
      console.error('âŒ Error en MapLibre:', e);
    });
  }
  
  // ============================================================================
  // FUNCIONES 3D
  // ============================================================================
  
  function add3DBuildings() {
    if (!map || !map.isStyleLoaded()) {
      console.warn('Estilo no cargado aÃºn');
      return;
    }

    // Verificar si ya existe la capa
    if (map.getLayer('3d-buildings')) {
      console.log('Capa 3D ya existe, mostrÃ¡ndola');
      map.setLayoutProperty('3d-buildings', 'visibility', 'visible');
      return;
    }

    try {
      // Buscar la primera capa de etiquetas para insertar debajo
      const layers = map.getStyle().layers;
      let labelLayerId;
      for (let i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout && layers[i].layout['text-field']) {
          labelLayerId = layers[i].id;
          break;
        }
      }

      // Agregar capa de extrusiÃ³n 3D con expresiones seguras
      map.addLayer({
        id: '3d-buildings',
        type: 'fill-extrusion',
        source: 'openmaptiles',
        'source-layer': 'building',
        minzoom: 14,
        paint: {
          'fill-extrusion-color': [
            'interpolate',
            ['linear'],
            ['coalesce', ['get', 'render_height'], 5],
            0, '#e8e8e8',
            5, '#d0d0d0',
            10, '#b8b8b8',
            20, '#a0a0a0',
            50, '#888888'
          ],
          'fill-extrusion-height': [
            'interpolate',
            ['linear'],
            ['zoom'],
            14, 0,
            14.05, ['*', ['coalesce', ['get', 'render_height'], 5], 1.2]
          ],
          'fill-extrusion-base': [
            'interpolate',
            ['linear'],
            ['zoom'],
            14, 0,
            14.05, ['coalesce', ['get', 'render_min_height'], 0]
          ],
          'fill-extrusion-opacity': 0.85,
          'fill-extrusion-vertical-gradient': true
        }
      }, labelLayerId);

      console.log('âœ… Capa 3D de edificios agregada correctamente');
    } catch (error) {
      console.error('âŒ Error agregando edificios 3D:', error);
    }
  }

  function setup3DLighting(intensity = 0.5) {
    if (!map || !map.isStyleLoaded()) return;

    try {
      map.setLight({
        anchor: 'viewport',
        color: '#ffffff',
        intensity: intensity,
        position: [1.5, 90, 80]
      });
      console.log('âœ… IluminaciÃ³n 3D configurada');
    } catch (error) {
      console.warn('IluminaciÃ³n no soportada:', error);
    }
  }

  function updateExtrusionFactor(factor) {
    if (!map || !map.getLayer('3d-buildings')) return;

    try {
      map.setPaintProperty('3d-buildings', 'fill-extrusion-height', [
        'interpolate',
        ['linear'],
        ['zoom'],
        14, 0,
        14.05, ['*', ['coalesce', ['get', 'render_height'], 5], factor]
      ]);

      console.log('âœ… Factor de extrusiÃ³n actualizado:', factor + 'x');
    } catch (error) {
      console.warn('Error actualizando factor de extrusiÃ³n:', error);
    }
  }
  
  let current3DRotation = 0;
  
  /* ============================================================================
   * CÃ“DIGO DXF COMENTADO - NO FUNCIONAL EN MAPLIBRE
   * ============================================================================
   * MapLibre no tiene el mÃ©todo latLngToContainerPoint() (es de Leaflet)
   * Este cÃ³digo requiere adaptaciÃ³n para usar project() de MapLibre
   * 
  // Cargar archivo DXF
  async function loadDXF() {
    try {
      const response = await fetch('./cadmapper-alcoy-valencia-es.dxf');
      const dxfString = await response.text();
      const parser = new window.DxfParser();
      dxfData = parser.parseSync(dxfString);
      console.log('DXF cargado:', dxfData);
      return true;
    } catch (error) {
      console.error('Error cargando DXF:', error);
      return false;
    }
  }
  */
  
  function toggle3DMode() {
    is3DEnabled = !is3DEnabled;
    const btn = $('#toggle-3d-btn');
    const rotationControls = $('#rotation-controls');
    const controlPanel = document.getElementById('control-panel-3d');

    console.log('ğŸ® Toggle 3D:', is3DEnabled ? 'ACTIVADO' : 'DESACTIVADO');
    console.log('ğŸ” Zoom actual:', map.getZoom());
    console.log('ğŸ“ Pitch actual:', map.getPitch());

    if (is3DEnabled) {
      // Activar vista 3D
      btn.textContent = 'Desactivar 3D';
      btn.classList.add('active');
      if (rotationControls) rotationControls.classList.add('visible');
      if (controlPanel) controlPanel.style.display = 'block';
      
      // Asegurar zoom mÃ­nimo para ver edificios 3D
      const currentZoom = map.getZoom();
      const targetZoom = currentZoom < 16 ? 17 : currentZoom;
      
      map.easeTo({
        pitch: 60,
        bearing: 0,
        zoom: targetZoom,
        duration: 1000
      });

      setTimeout(() => {
        console.log('ğŸ—ï¸ Agregando edificios 3D...');
        add3DBuildings();
        const lightValue = document.getElementById('light-slider')?.value || 0.4;
        setup3DLighting(parseFloat(lightValue));
      }, 1000);
    } else {
      // Desactivar vista 3D
      btn.textContent = 'Activar 3D';
      btn.classList.remove('active');
      if (rotationControls) rotationControls.classList.remove('visible');
      if (controlPanel) controlPanel.style.display = 'none';
      
      map.easeTo({
        pitch: 0,
        bearing: 0,
        duration: 1000
      });

      if (map.getLayer('3d-buildings')) {
        map.setLayoutProperty('3d-buildings', 'visibility', 'none');
        console.log('ğŸ—ï¸ Edificios 3D ocultos');
      }
    }
  }
  
  function rotateMap3D(degrees) {
    if (!is3DEnabled) return;
    
    const currentBearing = map.getBearing();
    map.easeTo({
      bearing: currentBearing + degrees,
      duration: 500
    });
  }
  
  function resetRotation3D() {
    if (!is3DEnabled) return;
    
    map.easeTo({
      bearing: 0,
      pitch: 60,
      center: [parcelaLng, parcelaLat],
      zoom: 18,
      duration: 1000
    });
  }

  // ============================================================================
  // FUNCIÃ“N: CAMBIAR ESTILO DE MAPA
  // ============================================================================
  function changeMapType(type) {
    if (!map) return;
    
    const styleUrl = MAP_STYLES[type];
    map.setStyle(styleUrl);

    // Recargar edificios 3D despuÃ©s de cambiar estilo
    map.once('styledata', () => {
      if (is3DEnabled) {
        setTimeout(() => {
          add3DBuildings();
          setup3DLighting(0.5);
        }, 500);
      }
    });
  }

  function colorFor(item){
    return colorByDominio[item.dominio] || '#a3a3a3';
  }

  function renderMap(){
    ensureMap();
    // MapLibre renderiza automÃ¡ticamente
    
    // Inicializar eventos del sidebar despuÃ©s de que el mapa estÃ© disponible
    setTimeout(initSidebarEvents, 500);
  }
  
  // FunciÃ³n especÃ­fica para inicializar los eventos del sidebar
  function initSidebarEvents() {
    console.log('Inicializando eventos del sidebar...');
    
    // Asegurarse de que el mapa estÃ© disponible
    if (!map) {
      console.error('Mapa no disponible para inicializar eventos del sidebar');
      return;
    }
    
    // CategorÃ­as para el sidebar principal
    const categoryMapping = {
      'Objetivo': 'objetivo',
      'Universidad': 'universidad',
      'Salud': 'salud',
      'Comercio': 'comercio',
      'Servicios': 'servicios',
      'Transporte': 'transporte',
      'Cultura/Parque': 'cultura'
    };
    
    // Recorrer cada categorÃ­a y aÃ±adir event listeners a los elementos
    Object.entries(categoryMapping).forEach(([category, containerId]) => {
      const container = document.getElementById(`cat-${containerId}`);
      if (!container) {
        console.warn(`No se encontrÃ³ el contenedor para: cat-${containerId}`);
        return;
      }
      
      // Seleccionar todos los elementos con la clase place-item dentro del contenedor
      const items = container.querySelectorAll('.place-item');
      console.log(`Encontrados ${items.length} elementos en cat-${containerId}`);
      
      // AÃ±adir event listeners a cada elemento
      items.forEach(item => {
        const placeId = item.getAttribute('data-place-id');
        if (!placeId) {
          console.warn('Elemento sin data-place-id:', item);
          return;
        }
        
        const place = PLACES.find(p => p.id === placeId);
        if (!place) {
          console.warn(`No se encontrÃ³ el lugar con ID: ${placeId}`);
          return;
        }
        
        if (!place.lat || !place.lon) {
          console.warn(`Lugar sin coordenadas: ${place.nombre}`);
          return;
        }
        
        const color = CAT_COLORS[category] || '#999';
        
        // AÃ±adir evento de clic directamente
        item.onclick = function() {
          console.log(`Click en ${place.nombre} (${placeId})`);
          
          // Resaltar el elemento seleccionado
          document.querySelectorAll('.place-item').forEach(el => {
            el.style.background = 'var(--chip)';
            el.style.borderColor = 'var(--grid)';
          });
          this.style.background = 'var(--panel)';
          this.style.borderColor = color;
          
          // Volar a la ubicaciÃ³n
          const lat = parseFloat(place.lat);
          const lon = parseFloat(place.lon);
          
          map.flyTo({
            center: [lon, lat],
            zoom: 17,
            duration: 1000
          });
          
          // Cerrar popups anteriores
          closeAllPopups();
          
          // Abrir el popup despuÃ©s de la animaciÃ³n
          setTimeout(() => {
            const marker = findMarkerByPlaceId(placeId);
            if (marker) {
              marker.togglePopup();
              window.currentOpenMarker = marker;
            } else {
              // Crear un popup temporal
              const popup = new maplibregl.Popup({
                closeButton: true,
                closeOnClick: true
              })
              .setLngLat([lon, lat])
              .setHTML(`<div class="popup-content"><h3>${place.nombre}</h3><div>${place.direccion || ''}</div></div>`)
              .addTo(map);
              
              window.currentOpenMarker = {
                togglePopup: () => popup.remove(),
                getPopup: () => ({ isOpen: () => true })
              };
            }
          }, 1100);
        };
      });
    });
    
    console.log('âœ… Eventos del sidebar inicializados correctamente');
  }

  // ---- Render principal ----
  function render(){
    if(state.view==='grid'){
      $('#grid').classList.remove('hidden');
      $('#mapview').classList.add('hidden');
      renderGrid();
    }else{
      $('#mapview').classList.remove('hidden');
      $('#grid').classList.add('hidden');
      renderMap();
    }
  }

  // ---- Funcionalidad pantalla completa para el mapa ----
  function toggleFullscreenMap() {
    const mapwrap = $('#mapview');
    const fullscreenBtn = $('#fullscreen-btn');
    const exitBtn = $('#exit-fullscreen-btn');
    
    if (mapwrap.classList.contains('fullscreen')) {
      // Salir de pantalla completa
      mapwrap.classList.remove('fullscreen');
      fullscreenBtn.style.display = 'block';
      exitBtn.style.display = 'none';
      document.body.style.overflow = '';
      // Cerrar sidebar si estÃ¡ abierto
      $('#map-sidebar').classList.remove('open');
    } else {
      // Entrar en pantalla completa
      mapwrap.classList.add('fullscreen');
      fullscreenBtn.style.display = 'none';
      exitBtn.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    // Redimensionar el mapa despuÃ©s del cambio
    setTimeout(() => {
      if (map) {
        map.resize();
      }
    }, 100);
  }
  
  // FunciÃ³n toggleSidebar eliminada

  // ============================================================================
  // INICIALIZACIÃ“N - Esperar a que el DOM estÃ© listo
  // ============================================================================
  document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸš€ DOMContentLoaded ejecutado');
    console.log('ğŸ“ Elementos del mapa encontrados:', {
      toggleBtn: !!$('#toggle-3d-btn'),
      fullscreenBtn: !!$('#fullscreen-btn'),
      mapContainer: !!$('#map')
    });
    
    // ============================================================================
    // SETUP INICIAL - Chips, Selects e Inputs
    // ============================================================================
    
    // Configurar chips de categorÃ­as
    setupChips();

    // Select de dominio (si existe)
    const selDom = $('#sel-dominio');
    if (selDom) {
      DOMINIOS.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        selDom.appendChild(opt);
      });
      selDom.addEventListener('change', e => {
        state.dominio = e.target.value;
        render();
      });
    }
    
    // Select de precio (si existe)
    const selPrecio = $('#sel-precio');
    if (selPrecio) {
      selPrecio.addEventListener('change', e => {
        state.precio = e.target.value;
        render();
      });
    }

    // Inputs de bÃºsqueda
    const qInput = $('#q');
    if (qInput) {
      qInput.addEventListener('input', e => {
        state.texto = e.target.value.trim();
        render();
      });
    }
    
    const qsInput = $('#qs');
    if (qsInput) {
      qsInput.addEventListener('input', e => {
        state.texto = e.target.value.trim();
        render();
      });
    }
    
    // Tabs de vista
    $$('.tab').forEach(t => t.addEventListener('click', e => {
      $$('.tab').forEach(x => x.dataset.active = 'false');
      t.dataset.active = 'true';
      state.view = t.dataset.view;
      render();
    }));
    
    // Event listeners para los botones de pantalla completa
    const fullscreenBtn = $('#fullscreen-btn');
    if (fullscreenBtn) {
      console.log('âœ… BotÃ³n de pantalla completa encontrado');
      fullscreenBtn.addEventListener('click', toggleFullscreenMap);
    } else {
      console.warn('âš ï¸ BotÃ³n de pantalla completa NO encontrado');
    }
    
    const exitFullscreenBtn = $('#exit-fullscreen-btn');
    if (exitFullscreenBtn) {
      exitFullscreenBtn.addEventListener('click', toggleFullscreenMap);
    }
    
    // Event listeners para modo 3D y rotaciÃ³n
    const toggle3DBtn = $('#toggle-3d-btn');
    if (toggle3DBtn) {
      console.log('âœ… BotÃ³n 3D encontrado');
      toggle3DBtn.addEventListener('click', () => {
        console.log('ğŸ¯ Click en botÃ³n 3D detectado');
        toggle3DMode();
      });
    } else {
      console.warn('âš ï¸ BotÃ³n 3D NO encontrado');
    }
    
    const rotateLeft = $('#rotate-left');
    if (rotateLeft) {
      rotateLeft.addEventListener('click', () => {
        console.log('âŸ² Rotando izquierda');
        rotateMap3D(-45);
      });
    }
    
    const rotateRight = $('#rotate-right');
    if (rotateRight) {
      rotateRight.addEventListener('click', () => {
        console.log('âŸ³ Rotando derecha');
        rotateMap3D(45);
      });
    }
    
    const resetRotation = $('#reset-rotation');
    if (resetRotation) {
      resetRotation.addEventListener('click', resetRotation3D);
    }
    
    // Event listeners para controles del panel 3D
    const extrusionSlider = document.getElementById('extrusion-slider');
    if (extrusionSlider) {
      extrusionSlider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        document.getElementById('extrusion-value').textContent = value.toFixed(1) + 'x';
        updateExtrusionFactor(value);
      });
    }

    const pitchSlider = document.getElementById('pitch-slider');
    if (pitchSlider) {
      pitchSlider.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        document.getElementById('pitch-value').textContent = value + 'Â°';
        if (map) map.setPitch(value);
      });
    }

    const bearingSlider = document.getElementById('bearing-slider');
    if (bearingSlider) {
      bearingSlider.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        document.getElementById('bearing-value').textContent = value + 'Â°';
        if (map) map.setBearing(value);
      });
    }

    const lightSlider = document.getElementById('light-slider');
    if (lightSlider) {
      lightSlider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        document.getElementById('light-value').textContent = value.toFixed(2);
        setup3DLighting(value);
      });
    }
    
    // Event listeners para el botÃ³n de sidebar eliminados

    // Event listener para el botÃ³n de rutas
    const routesToggle = $('#routes-toggle');
    const routesContainer = $('#routes-container');
    if (routesToggle && routesContainer) {
      routesToggle.addEventListener('click', () => {
        routesContainer.classList.toggle('open');
      });
    }

    // Event listeners para los selectores de tipo de mapa
    const mapTypeNormal = $('#map-type-normal');
    if (mapTypeNormal) {
      mapTypeNormal.addEventListener('change', (e) => {
        changeMapType(e.target.value);
        // Sincronizar con selector de pantalla completa
        const fullscreenSelector = $('#map-type-fullscreen');
        if (fullscreenSelector) fullscreenSelector.value = e.target.value;
      });
    }
    
    const mapTypeFullscreen = $('#map-type-fullscreen');
    if (mapTypeFullscreen) {
      mapTypeFullscreen.addEventListener('change', (e) => {
        changeMapType(e.target.value);
        // Sincronizar con selector normal
        const normalSelector = $('#map-type-normal');
        if (normalSelector) normalSelector.value = e.target.value;
      });
    }

    // Event listeners para filtros en pantalla completa
    const qFullscreen = $('#q-fullscreen');
    if (qFullscreen) {
      qFullscreen.addEventListener('input', (e) => {
        state.texto = e.target.value.trim();
        const q = $('#q');
        const qs = $('#qs');
        if (q) q.value = state.texto;
        if (qs) qs.value = state.texto;
        render();
      });
    }

    // Salir de pantalla completa con la tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $('#mapview').classList.contains('fullscreen')) {
        toggleFullscreenMap();
      }
    });

    // Primer render
    render();
    
    // Forzar re-render del mapa despuÃ©s de un breve delay para asegurar que los colores se actualicen
    setTimeout(() => {
      if (state.view === 'map' && map) {
        renderMap();
      }
    }, 500);
  }); // Fin DOMContentLoaded

  // ---- PROTECCIÃ“N CONTRA HERRAMIENTAS DE DESARROLLADOR ----
  
  // Desactivar menÃº contextual (clic derecho)
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });

  // Desactivar teclas de herramientas de desarrollador
  document.addEventListener('keydown', function(e) {
    // F12
    if (e.key === 'F12') {
      e.preventDefault();
      return false;
    }
    
    // Ctrl+Shift+I (Inspector)
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
      e.preventDefault();
      return false;
    }
    
    // Ctrl+Shift+J (Consola)
    if (e.ctrlKey && e.shiftKey && e.key === 'J') {
      e.preventDefault();
      return false;
    }
    
    // Ctrl+U (Ver cÃ³digo fuente)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      return false;
    }
    
    // Ctrl+Shift+C (Selector de elementos)
    if (e.ctrlKey && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      return false;
    }
    
    // Ctrl+S (Guardar pÃ¡gina)
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      return false;
    }
  });

  // Detectar si las herramientas de desarrollador estÃ¡n abiertas (segunda instancia)
  let devtoolsStatusSecond = {
    open: false,
    orientation: null
  };

  // FunciÃ³n para detectar si es un dispositivo mÃ³vil
  function isMobileDevice() {
    return (typeof window.orientation !== 'undefined') || 
           (navigator.userAgent.indexOf('IEMobile') !== -1) ||
           (navigator.userAgent.indexOf('Android') !== -1 && navigator.userAgent.indexOf('Mobile') !== -1) ||
           (navigator.userAgent.indexOf('iPhone') !== -1) ||
           (navigator.userAgent.indexOf('iPad') !== -1) ||
           (navigator.userAgent.match(/iPad|iPhone|iPod|Android|BlackBerry|Windows Phone/i));
  }
  
  setInterval(() => {
    // No aplicar esta detecciÃ³n en dispositivos mÃ³viles
    if (isMobileDevice()) {
      return; // Permitir acceso desde dispositivos mÃ³viles
    }
    
    const devThreshold = 160; // Variable local para evitar duplicados
    if (window.outerHeight - window.innerHeight > devThreshold || 
        window.outerWidth - window.innerWidth > devThreshold) {
      if (!devtoolsStatusSecond.open) {
        devtoolsStatusSecond.open = true;
        // Redirigir o mostrar mensaje de advertencia
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial;background:#000;color:#fff;"><h1>Acceso no autorizado</h1></div>';
      }
    } else {
      devtoolsStatusSecond.open = false;
    }
  }, 500);

  // Desactivar selecciÃ³n de texto
  document.onselectstart = function() {
    return false;
  };

  // Desactivar arrastrar elementos
  document.ondragstart = function() {
    return false;
  };
</script>
</body>
</html>
